<!DOCTYPE html>
<html>
<head>
<title>Tabular Tracker Capture</title>
<meta charset="UTF-8">

	<script src="js/jQuery/jquery-1.11.1.min.js"></script>
	<script src="js/jQuery/jquery-ui.min.js"></script>
	<script src="js/jQuery/jquery.ui.core.js"></script>
	<script src="js/jQuery/jquery.ui.widget.js"></script>
	<script src="js/jQuery/jquery.ui.datepicker.js"></script>
	<script src="js/jQuery/jquery.dateFormat-1.0.js"></script>
	<script src="js/jQuery/jquery.watermark.js"></script>
	<script src="js/jQuery/jquery.cookie.js"></script>

	<script src="js/gmap3/gmap3.min.js"></script> 
	<script src="js/gmap3/gmap3-menu.js"></script>

	<script src="js/app/dialogLoading.js"></script>
	<script src="js/app/util.js"></script>
	<script src="js/app/RESTUtil.js"></script>
	
	<link rel="stylesheet" href="css/jQuery/jquery.ui.all.css">
	<link rel="stylesheet" href="css/jQuery/jquery-ui.css" />
	<link rel="stylesheet" href="css/gmap3/gmap3-menu.css" />
	<link rel="stylesheet" href="css/app/style.css">
	<script>

		// Global variables/objects
		var _Success = 1;
		var _Fail = 0;

		var _dateFormat_Picker_YYMMDD = "yy/mm/dd";
		var _dateFormat_Picker_YYMMDD_Dash = "yy-mm-dd";
		var _dateFormat_YYYYMMDD = "yyyy/MM/dd";
		var _dateFormat_YYYYMMDD_Dash = "yyyy-MM-dd";
		
		var _dateFormat_DDMMMYYYY = "dd MMM yyyy";

		var _status_ACTIVE = "ACTIVE";
		var _status_CANCELLED = "CANCELLED";
		var _status_COMPLETED = "COMPLETED";

		var _view = 'view';
		var _view_Y = 'y';

		var _controlsTemplate = "<input type='text' class='datepicker' style='display:none;' size='11' /><input class='textbox' style='display:none;' type='text' size='15' height='20px' /><input class='checkbox' style='display:none;' type='checkbox' /><select class='dropdown' style='display:none;'><option value=''>Select Value</option></select><span class='label' style='display:none;'></span>";


		// -- App Manifest Json
		var _appManifest = $.parseJSON( RESTUtil.getSynchData( 'manifest.webapp' ) );


		// -- URLs
		var _appURL = _appManifest.activities.dhis.href.replace( '/dhis-web-maintenance-appmanager', '' ) + '/';

		var _dhisURL = _appURL + 'dhis-web-dashboard-integration/index.action';

		var _queryURL_api = _appURL + 'api/';

		var _queryURL_me = _queryURL_api + "me";

		var _queryURL_systemInfo = _queryURL_api + "system/info"

		var _queryURL_appTitle = _queryURL_api + 'systemSettings?key=applicationTitle';

		var _queryURL_OrgUnit = _queryURL_api + "organisationUnits";

		var _queryURL_Program = _queryURL_api + "programs/";
		var _queryURL_ProgramList = _queryURL_api + "programs.json";      // type = 1 is MEwR type
		var _queryURL_ProgramStages = _queryURL_api + "programStages";
		var _queryURL_DataElementDetail = _queryURL_api + "dataElements/";
		var _queryURL_OptionSets = _queryURL_api + "optionSets/";

		var _queryURL_ProgramStageInstance = _queryURL_api + "events/"; 

		var _queryURL_PersonSubmit = _queryURL_api + "trackedEntityInstances";
		var _queryURL_PersonQuery = _queryURL_api + "trackedEntityInstances"; 

		var _queryURL_PersonAttributes = _queryURL_api + "trackedEntityAttributes.json?paging=false&viewClass=detail&fields=*,optionSet[id,name,options]";

		var _queryURL_TrackedEntities = _queryURL_api + "trackedEntities";

		var _queryURL_EventQuery = _queryURL_api + "events.json?paging=false";
		var _queryURL_EventSubmit = _queryURL_api + "events";

		var _queryURL_ProgramEnrollmentSubmit = _queryURL_api + "enrollments";
		var _queryURL_ProgramEnrollmentQuery = _queryURL_api + "enrollments.json";

		var _queryURL_PersonDataValidate = _appURL + "dhis-web-caseentry/validateTrackedEntityInstance.action";


		// -- Instance variables
		var _today = new Date();

		var _TabularDEObj;

		var _weekStartDate;
		var _weekEndDate;

		var _isOver2_16 = false;

		// =========================================================
		// On Page Load Run

		$( document ).ready( function() {

			// Create a static class method for these setup.
			DialogLoading.initialSetup();


			// ------------ Run once after page load ------------
			_TabularDEObj = new TabularDataEntry();

		});


		// Class / Function Orders

		// - TabularDataEntry Class
		// - SearchPanel
		// - DefaultProgram_TEA_Manager
		// - ProgramManager
		// - PersonList
		// - PersonEvent Class

		// - DataInMemory Class

		// - PersonDialogForm Class
		// - LanguageSetting Class
		// - SettingForm Class
		// - OrgUnitMapPopup

		// - GMapHelper (Static)

		// - FormUtil Class (Static)
		// - PersonUtil Class (Static)
		// - EventUtil Class (Static)
		// - Weekly Class (Static)
		// - Monthly Class (Static)		
		// - DBSetting Class (Static)

		// In included js file
		// - DialogLoading Class (Static)
		// - Util Class (Static)		
		// - RESTUtil Class (Static)


		// =========================================================
		//  Classes

		// -------------------------------------------
		// Class - TabularDataEntry
		//			- The main class.  This class represents the entire TabularDataEntry, thus, includes all the class/object.
		function TabularDataEntry()
		{
			var me = this;

			// App Setting Form Popup
			this.settingForm = new SettingForm();

			// Data in memory access
			this.dataInMemory = new DataInMemory();

			// Setting Related
			this.searchPanel = new SearchPanel( me );

			// Person List
			this.personList = new PersonList( me );

			// Language List
			this.languageSetting = new LanguageSetting( me );

			// OrgUnitMap Popup
			this.orgUnitMapPopup = new OrgUnitMapPopup( me );

			// Test Data Tag - 
			this.TestOutputDivTag = $( "#moreOptionDetail" );


			// --------------------------
			// Method Calls From Child Object to each other

			// SearchPanel Related 

			this.populateProgramStages = function( programStageTag, programVal )
			{
				me.searchPanel.programManager.populateProgramStages( programStageTag, programVal );
			}

			this.populatePrograms = function( programTag )
			{
				me.searchPanel.programManager.populatePrograms( programTag );
			}

			this.getProgramStageList = function( programId )
			{
				return me.searchPanel.programManager.getProgramStageList( programId );
			}

			this.resetUnderPersonOptions = function()
			{
				me.searchPanel.resetUnderPersonOptions();
			}

			this.getOrgUnitId = function()
			{
				return me.searchPanel.getOrgUnitId();
			}

			this.getEventQueryBaseUrl = function()
			{
				return me.searchPanel.getEventQueryBaseUrl();
			}

			this.getSelectedProgramId = function()
			{
				return me.searchPanel.programManager.selectedProgramId;
			}

			this.getSelectedProgram = function()
			{
				return me.searchPanel.programManager.selectedProgram;
			}

			this.getSelectedProgramType = function()
			{
				return me.searchPanel.programManager.getSelectedProgramType();
			}

			this.isCase_MEwR = function()
			{
				return me.searchPanel.programManager.isCase_MEwR();
			}

			this.isCase_SEwoR = function()
			{
				return me.searchPanel.programManager.isCase_SEwoR();
			}

			this.getDefaultStartDate = function()
			{
				return me.searchPanel.getDefaultStartDate();
			}

			this.getDefaultEndDate = function()
			{
				return me.searchPanel.getDefaultEndDate();
			}

			this.getSearchProgramStatus = function()
			{
				return me.searchPanel.getSearchProgramStatus();
			}

			this.setPersonFoundNoSpanTag = function( inputText )
			{
				me.searchPanel.personFoundNoSpanTag.html( inputText );	
			}

			this.getProgramList_Full = function()
			{
				return me.searchPanel.programManager.getProgramList_Full();
			}

			this.getProgramStageList_Full = function()
			{
				return me.searchPanel.programManager.getProgramStageList_Full();
			}

			this.getProgramStageData_ById = function( programStageId )
			{
				return me.searchPanel.programManager.getProgramStageData_ById( programStageId );
			}

			this.getProgramTrackedEntityAttributes = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getProgramTrackedEntityAttributes();
			}

			this.getFirstDisplayAttribute = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getFirstDisplayAttribute();
			}

			this.getInDisplayListCount = function()
			{
				return me.searchPanel.defaultProgram_TEA_Manager.getInDisplayListCount();
			}


			// PersonList Related 
			this.resetMainList = function()
			{
				me.personList.resetMainList();
			}

			this.populatePersonData = function( returnFunc )
			{
				return me.personList.populatePersonData( returnFunc );
			}

			this.retrieveAndPopulateEvents = function( tableCurrent, execFunc )
			{
				return me.personList.personEvent.retrieveAndPopulateEvents( tableCurrent, execFunc );
			}

			this.getMainPersonTableTag = function()
			{
				return me.personList.mainPersonTableTag;
			}

			this.hideMainSections = function()
			{
				return me.personList.hideMainSections();
			}

			this.showMainSection = function()
			{
				return me.personList.showMainSection();
			}

			this.getJson_PersonList_EventDateChecked = function()
			{
				return me.personList.json_PersonList_EventDateChecked;
			}

			this.getPerson_WithDoneStage = function( personId, execFunc )
			{
				return me.personList.getPerson_WithDoneStage( personId, execFunc );
			}

			this.retreivePersonListWithEvents = function( populateFunc )
			{
				return me.personList.personEvent.retreivePersonListWithEvents( populateFunc );
			}

			this.setPersonInfoRow = function( trCurrent, item_person )
			{
				me.personList.setPersonInfoRow( trCurrent, item_person );
			}

			this.programEnroll = function( personId, programId, eventDateInFormat, newlyEnrolledAction, successAction, failAction )
			{
				return me.personList.programEnroll( personId, programId, eventDateInFormat, newlyEnrolledAction, successAction, failAction );
			}

			this.createPersonTableHeaders = function( programTrackedEntityAttributes )
			{
				me.personList.createPersonTableHeaders( programTrackedEntityAttributes );
			}

			this.populatePersonAttirbutesToRow = function( trCurrent, attributes )
			{
				me.personList.populatePersonAttirbutesToRow( trCurrent, attributes );
			}

			this.addTo_DoneStage = function( trPersonRow, stageId )
			{
				me.personList.addTo_DoneStage( trPersonRow, stageId );
			}

			// ========================================================

			// Methods
			this.setupTopSection = function()
			{
				// Set click event - back to application
				$( '#headBanner,#headerText,#closeButton' ).click( function() { window.location.href = _dhisURL; } );

				// Get application title
				$.get( _queryURL_appTitle, function( json_Data )
				{
					$( '#headerText' ).text( Util.getNotEmpty( json_Data.applicationTitle ) );
				});


				$( '#settingFormOpen' ).click( function()
				{
					me.settingForm.openForm();

					return false;
				});
			}

			this.checkIfVersionOver2_16 = function()
			{
				// Look for DHIS version in web api
				RESTUtil.getAsynchData( _queryURL_systemInfo
				, function( json_data ) 
				{
					var version = json_data.version;
					console.log(version);
					_isOver2_16 = Util.checkIfVersionOverTarget( version, "2.16" );
					if( _isOver2_16 ){
						EventUtil.preferredOptionGenerator = EventUtil.over2_16_OptionGenerator;
					} else {
						EventUtil.preferredOptionGenerator = EventUtil.defaultOptionGenerator;
					} 
				});
			}

			// ========================================================

			this.initialSetup = function( )
			{	

				me.setupTopSection();

				me.checkIfVersionOver2_16();

				// get Setting Data to keep in memory and check for required setting data for this app.
				me.settingForm.loadSettingDataInitially_AndCheckRequired();

				// Hide the person list.
				me.searchPanel.setVisibility_MainSectionDiv( false );

				// Initially set focus on OrgUnit Search Tag
				me.searchPanel.orgUnitNameTag.focus();

			}


			// Initial Setup Call
			this.initialSetup( );
		}

		// Class - TabularDataEntry
		// -------------------------------------------


		// -------------------------------------------
		// Class - SearchPanel
		//			- Setting data holding class
		function SearchPanel( TabularDEObj )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.queryURL_OrgUnit = _queryURL_api + 'organisationUnits/'; //EmUlPkdz1t8.json?viewClass=basic
			this.queryURL_OrgUnitNameQuery = _queryURL_api + 'organisationUnits.json'; 
			
			// Tages..
			this.orgUnitMapSmall_DivTag = $( '#orgUnitMapSmall' );
			this.orgUnitRowTag = $( '#orgUnitRow' );
			this.orgUnitNameTag = $( '#orgUnitName' );	// Default OrgUnit Search By Name

			this.defaultDateRowTag = $( '#defaultDateRow' );
			this.defaultDateTag = $( '#defaultDate' );
			this.defaultDateFromTag = $( '#defaultDateFrom' );
			this.defaultDateToTag = $( '#defaultDateTo' );

			this.periodRadio_MonthTag = $( '#periodRadio_Month' );

			
			this.defaultProgramRowTag = $( '#defaultProgramRow' );
			this.defaultProgramTag = $( '#defaultProgram' );
			this.defaultProgramNoteSpanTag = $( '#defaultProgramNote' );
			this.personFoundNoSpanTag = $( '#personFoundNo' );
			this.personList_DescSpanTag = $( '#personList_Desc' );

			this.personEventSearchOptionsTag = $( '#personEventSearchOptions' );

			this.programStatusListTag = $( '#programStatusList' );
			this.searchAllProgramTag = $( '#searchAllProgram' );
			this.listAllPersonHistoricalEventsTag = $( '#listAllPersonHistoricalEvents' );

			this.searchResultMsgRowTag = $( '#searchResultMsgRow' );
			this.searchResultMessageTag = $( '#searchResultMessage' );

			this.defaultDateType;
			this.defaultDateFrom;
			this.defaultDateTo;
			
			// Set program manager
			this.programManager = new ProgramManager( me.TabularDEObj, me.defaultProgramTag );

			//this.json_PersonList = null;

			this.defaultProgram_TEA_Manager = new DefaultProgram_TEA_Manager();

			this.countrySelectedId;
			this.orgUnitSelectedId;
		
			this.userAccessableOrgUnits;
			
			this.countryOrgUnitId = "";
			
			// ----------------------------------
			// Functions 

			
			this.getCountryId = function()
			{
				return me.countryOrgUnitId;
			}
						
			this.setCountryId = function( orgUnitId )
			{
				me.countryOrgUnitId = "";

				var countryLevel = me.TabularDEObj.settingForm.getCountryLevel();

				if ( countryLevel !== undefined )
				{
					$.get( me.queryURL_OrgUnit + orgUnitId + '/parents.json', function( json_data )
					{
						$.each( json_data.organisationUnits, function( i, item )
						{
							if ( item.level == countryLevel )
							{
								me.countryOrgUnitId = item.id;
								
								return false;
							}
						});					
					});
				}
			}
			
			this.setOrgUnitTags = function( orgUnit ) 
			{
				me.orgUnitNameTag.val( orgUnit.name );
				me.orgUnitSelectedId = orgUnit.id;

				Util.paintClear( me.orgUnitNameTag );
			}

			this.getOrgUnitId = function()
			{
				return me.orgUnitSelectedId;
			}


			this.retrieveUserAccessOrgUnits = function( execFunc )
			{
				RESTUtil.getAsynchData( _queryURL_me
				, function( json_data ) 
				{
					me.userAccessableOrgUnits = json_data.organisationUnits;
					execFunc();
				});					
			}

			this.displayOrgUnitPersonCount = function( orgUnitId )
			{
				var personFoundCount = 0;

				// Set small page size since we only need number from total count
				$.get( _queryURL_PersonQuery + ".json?pageSize=5&ou=" + orgUnitId, function( personList )
				{
					//me.json_PersonList = personList;

					if( personList !== undefined )
					{
						personFoundCount = personList.metaData.pager.total;

						me.personFoundNoSpanTag.text( "P" + personFoundCount );
						me.personFoundNoSpanTag.attr( "title", "Person Found: " + personFoundCount );
					}					
				});
			}

			this.clear_OrgUnitData = function()
			{
				delete me.orgUnitSelectedId;
				me.personFoundNoSpanTag.text( '' ).attr( "title", "" );	
				me.orgUnitMapSmall_DivTag.hide( '500' );
			}
			
			this.resetSetting_OrgUnitAndBelow = function()
			{
				me.orgUnitNameTag.val( '' );

				me.clear_OrgUnitData();

				me.setVisibility_Section( me.orgUnitRowTag, false );

				me.resetSetting_ProgramAndBelow();
			}

			this.resetSetting_ProgramAndBelow = function()
			{
				// program related reset
				me.programManager.resetSelectedProgram();

				me.defaultProgram_TEA_Manager.setProgramTrackedEntityAttributes( new Array() );
				me.defaultProgramNoteSpanTag.text( '' );

				// Should set as a function for reset
				me.setVisibility_Section( me.defaultProgramRowTag, false );	

				me.resetSetting_PeriodAndBelow();
			}


			this.resetSetting_PeriodAndBelow = function()
			{
				me.hidePeriodInputs();

				Util.paintAttention( me.defaultDateRowTag.find( 'input[type="radio"]' ).prop( 'checked', false ) );

				me.setVisibility_Section( me.defaultDateRowTag, false );	

				me.resetUnderPersonOptions();
				me.resetMainDataRelated();
			}


			this.resetUnderPersonOptions = function()
			{
				me.programStatusListTag.val( _status_ACTIVE );

				me.searchAllProgramTag.prop( 'checked', false );
				me.listAllPersonHistoricalEventsTag.prop( 'checked', false );
				
				me.setVisibility_Section( me.personEventSearchOptionsTag, false );
			}


			this.resetMainDataRelated = function()
			{
				me.setVisibility_MainSectionDiv( false );

				//json_PersonList = null;

				me.personList_DescSpanTag.html( "" );
				me.searchResultMsgRowTag.hide();
				me.searchResultMessageTag.text( "" );
			}


			this.setVisibility_Section = function( sectionTag, visible )
			{
				Util.disableTag( sectionTag, !visible );

				if( !visible )
				{
					sectionTag.slideUp( 400 );
				}
				else
				{
					sectionTag.slideDown( 400 );
				}
			}

			this.setVisibility_MainSectionDiv = function( visible )
			{
				me.TabularDEObj.hideMainSections();
				
				if ( visible )
				{
					me.TabularDEObj.showMainSection(); 
				}
			}


			this.retrieveProgramPersonAttributeData = function( programId, returnFunc )
			{
				var programTrackedEntityAttributes = new Array();

				if ( programId != '' )
				{
					RESTUtil.getAsynchData( _queryURL_Program + programId + '.json?fields=id,programTrackedEntityAttributes'
						, function( json_Program )
						{
							if ( json_Program.programTrackedEntityAttributes !== undefined )
							{
								$.each( json_Program.programTrackedEntityAttributes, function( i_attribute, item_attribute ) 
								{
									programTrackedEntityAttributes.push( { "id": item_attribute.trackedEntityAttribute.id, "name": item_attribute.trackedEntityAttribute.name, "mandatory": item_attribute.mandatory, "displayInList": item_attribute.displayInList } );
								});
							}

							returnFunc( programTrackedEntityAttributes );
						}
					);
				}
				else
				{
					returnFunc( programTrackedEntityAttributes );
				}
			}

			
			this.getEventQueryBaseUrl = function()
			{
				return _queryURL_EventQuery + '&programStatus=' + me.programStatusListTag.val();
			}

			this.getSearchProgramStatus = function()
			{
				return me.programStatusListTag.val();
			}

			// ----------------------------------
			// Event related

			this.setUp_OrgUnitAutoSelection = function( orgUnitNameTag )
			{
				orgUnitNameTag.autocomplete( {
					source: 
						function(request, response) 
						{
							// Reset orgUnitSelectedId and below section
							me.clear_OrgUnitData();

							me.resetSetting_ProgramAndBelow();


							var json_orgUnitList_new = new Array();

							if ( request.term.length >= 2 )
							{

								RESTUtil.getAsynchData( me.queryURL_OrgUnitNameQuery + '?filter=name:like:' + request.term + '&fields=name,id,level'
								, function( json_orgUnits ) 
								{

									var json_orgUnitList = json_orgUnits.organisationUnits;


									if( Util.checkDataExists( json_orgUnitList ) )
									{
										var deferredArrActions_ouAccessCheck = [];

										QuickLoading.dialogShowAdd( 'orgUnitLoading' );

										$.each( json_orgUnitList, function( i_ou, item_ou)
										{

											deferredArrActions_ouAccessCheck.push( RESTUtil.getAsynchData( me.queryURL_OrgUnit + item_ou.id + '/parents.json?fields=name,id,level', function( json_orgUnitParents ) 
											{
												var isUserAccessOU = false;

												var parentOUs = json_orgUnitParents.organisationUnits;

												if ( Util.checkValue( parentOUs ) )
												{
													$.each( parentOUs, function( i_parentOU, item_parentOU )
													{
														$.each( me.userAccessableOrgUnits, function( i_userOU, item_userOU)
														{
															if ( item_userOU.id == item_parentOU.id )
															{
																isUserAccessOU = true;
																return false;
															}
														});

														if ( isUserAccessOU ) return false;

													});
												}

												if ( isUserAccessOU )
												{													
													var itemLabel = item_ou.name + " ( lvl:" + item_ou.level;

													if ( Util.getNotEmpty( item_ou.code ).length > 0)
													{
														itemLabel += ", code:" + Util.getNotEmpty( item_ou.code );
													}

													itemLabel += " )";

													json_orgUnitList_new.push( { "id": item_ou.id, "label": itemLabel, "value": item_ou.name, "orgUnit": item_ou } );
												}
											}
											, function() {}
											) );
										});


										$.when.apply($, deferredArrActions_ouAccessCheck ).then( function( ) 
										{
											QuickLoading.dialogShowRemove( 'orgUnitLoading' );

											var json_orgUnitList_new_Sorted = Util.sortByKey( json_orgUnitList_new, "value" );


											response( json_orgUnitList_new_Sorted );
										});
									}
								}
								, function() {}
								, function() { QuickLoading.dialogShowAdd( 'orgUnitLoading' ); }
								, function() { QuickLoading.dialogShowRemove( 'orgUnitLoading' ); }								
								);

								if ( json_orgUnitList_new.length == 0 )
								{
									response( json_orgUnitList_new );
								}

							}
							else
							{
								response( json_orgUnitList_new );

								Util.paintAttention( orgUnitNameTag );
							}
						}
					,
					minLength: 0,
					delay: 500,
					//close: function() { this.value=''; },
					select: 
						function( event, ui ) {

							DialogLoading.openWithCallback( 
								function()
								{ 
									var orgUnitId = ui.item.orgUnit.id;

									// TODO: 1 - TTRY ASYNC CALLS AT HERE

									me.setVisibility_Section( me.defaultProgramRowTag, true );

									// Set OrgUnit
									me.setOrgUnitTags( ui.item.orgUnit );


									// Re-retrieve the programManager based on the orgUnit
									me.programManager.loadProgramList( orgUnitId );


									// Set the country orgUnit
									me.setCountryId( orgUnitId );
									
									// Notify person count in the org unit
									me.displayOrgUnitPersonCount( orgUnitId );
									
									//me.setStatus_PopulateButton();

									DialogLoading.close();

									
									// Setup the orgUnit Map
									me.setUp_OrgUnitMap( orgUnitId );


									me.defaultProgramTag.focus();
								}
							);							
						}
				} );
			}



			// On reset orgunit, we need to remove the map from image, etc..

			this.setUp_OrgUnitMap = function( ouId )
			{
				// Get orgunit coordinate first
				RESTUtil.getAsynchData( me.queryURL_OrgUnit + ouId + '.json?fields=id,coordinates'
				, function( json_orgUnit ) 
				{
					if ( json_orgUnit.coordinates !== undefined )
					{
						var coordinatesData = $.parseJSON( json_orgUnit.coordinates );
						//[36.630948,-0.981278]

						if ( coordinatesData.length == 2 )
						{
							var longitude = coordinatesData[0];
							var latitude = coordinatesData[1];

							var mapUrl = 'https://maps.googleapis.com/maps/api/staticmap?';

							mapUrl += 'zoom=9&size=120x80';

							mapUrl += '&markers=size:tiny%7Ccolor:blue%7Clabel:S%7C' + latitude + ',' + longitude;

							mapUrl += '&center=' + latitude + ',' + longitude;

							// Set the map info
							$( '#orgUnitMapImage' ).attr( 'src', mapUrl ).attr( 'lat', latitude ).attr( 'lng', longitude );

							me.orgUnitMapSmall_DivTag.show( '600' );
						}
					}

				}
				, function() 
				{
					console.log( 'Failed to retrieve the org unit - during org unit map setup' );
				});
			}

			this.setUp_OrgUnitMapClick = function( )
			{
				$( '#orgUnitMapAnchor' ).click( function()
				{
					var orgUnitMapPopupForm = me.TabularDEObj.orgUnitMapPopup;

					// Set the image first
					var mapImgTag = $( this ).find( 'img' );
					
					//console.log( 'mapImgTag: ' + mapImgTag.length );

					orgUnitMapPopupForm.setUp_Map( mapImgTag.attr( 'lat' ), mapImgTag.attr( 'lng' ) );
					
					orgUnitMapPopupForm.dialogFormTag.dialog( "open" );

					return false;
				});
			}

			this.setPeriod_DefaultDates = function( date )
			{
				// Set day
				//me.defaultDateTag.val( $.format.date( date, _dateFormat_YYYYMMDD ) );

				// Set Week
				$( '#defaultWeek' ).val( Weekly.getLastWeekStr( date ) );

				// Set Month
				Monthly.setDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ), date );

				var yesterday = new Date( date.getFullYear(), date.getMonth(), date.getDate() - 1 );

				// Date Period
				me.defaultDateFromTag.val( $.format.date( yesterday, _dateFormat_YYYYMMDD ) );
				me.defaultDateToTag.val( $.format.date( yesterday, _dateFormat_YYYYMMDD ) );
			}


			this.setPeriod_Events = function()
			{
				// Setup click event
				$( "input[type='radio'][name='period']" ).click( function() 
				{
					me.hidePeriodInputs();

					var radioBtn = $( this ).attr( 'value' );

					
					if ( radioBtn == 'month' )
					{
						$( '#defaultMonth' ).show();
					}
					else if ( radioBtn == 'week' )
					{
						$( '#defaultWeek' ).show();
					}
					else if ( radioBtn == 'custom' )
					{
						$( '#defaultDatePeriod' ).show();
					}

					me.defaultDateType = radioBtn;

					// Enable the populate button since date has been changed..
					//me.setStatus_PopulateButton();

					if ( me.TabularDEObj.isCase_MEwR() ) 
					{
						me.setVisibility_Section( me.personEventSearchOptionsTag, true );
					}

					// Perform the retrieval action
					me.performDataRetrieval();

				});		


				$( "input[type='radio'][name='period']" ).keydown( function( event ) 
				{
					if ( event.keyCode == 13 )
					{
						$( this ).click();
					}
				});

			}

			this.hidePeriodInputs = function()
			{
				$( '#defaultMonth' ).hide();
				$( '#defaultWeek' ).hide();
				$( '#defaultDatePeriod' ).hide();
			}

			this.getDefaultStartDate = function()
			{
				var date;

				if ( me.defaultDateType  == 'day' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDate' ).val() );
				}
				else if ( me.defaultDateType  == 'week' )
				{
					date = Weekly.getStartDate( $( '#defaultWeek' ).val() );
				}
				else if ( me.defaultDateType  == 'month' )
				{
					date = Monthly.getStartDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );
				}
				else if ( me.defaultDateType  == 'custom' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDateFrom' ).val() );
				}
				
				return date;
			}


			this.getDefaultEndDate = function()
			{
				var date;

				if ( me.defaultDateType  == 'day' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDate' ).val() );
				}
				else if ( me.defaultDateType  == 'week' )
				{
					date = Weekly.getEndDate( $( '#defaultWeek' ).val() );
				}
				else if ( me.defaultDateType  == 'month' )
				{
					date = Monthly.getEndDate( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );
				}
				else if ( me.defaultDateType  == 'custom' )
				{
					date = Util.getDate_FromYYYYMMDD( $( '#defaultDateTo' ).val() );
				}
								
				return date;
			}


			this.setDefaultDatePeriod_Related = function()
			{

				// Set Default Date RadioButton as 'Date'
				$( "input[type='radio'][name='period'][value='day']" ).prop('checked', true );
				me.defaultDateType  = 'day';
				$( '#defaultDate' ).show();
				
				// Set up the weekly date picker control
				Weekly.setWeekPicker( $( '#defaultWeek' ), me.performDataRetrieval );


				// Monthly Select List populate and event set.
				Monthly.populateMonthYear( $( '#defaultMonth_Month' ), $( '#defaultMonth_Year' ) );


				// Set the Default Date as today
				me.setPeriod_DefaultDates( _today );


				// ------------------------
				// Events Related

				me.setPeriod_Events();


				// On Date picker Selection, enable/disable Populate button depending on chocies
				Util.setupDatePicker( $( '.defaultDatePicker' ), function() 
				{
					me.performDataRetrieval();
				} );				


				// On Month/Year selection, Populate Option Checkbox selectoin, enable/disable Populate button depending on chocies
				$( '#defaultMonth_Month, #defaultMonth_Year' ).change( function() 
				{
					me.performDataRetrieval();

					// Enable the populate button since date has been changed..
					//me.setStatus_PopulateButton();					
				});

			}


			this.setDefaultProgramTag_Change = function()
			{

				me.defaultProgramTag.change( function() 
				{
					me.programManager.resetSelectedProgram();

					me.defaultProgramNoteSpanTag.text( '' );

					me.resetSetting_PeriodAndBelow();

					var selectedProgramId = $( this ).val();
					me.programManager.setSelectedProgram( selectedProgramId );

					if( selectedProgramId == '' )
					{
						me.defaultProgramNoteSpanTag.text( '*Please select a program.' );
						Util.paintAttention( me.defaultProgramTag );

						//me.setStatus_PopulateButton();					
					}
					else
					{

						Util.paintClear( me.defaultProgramTag );
					
						me.setVisibility_Section( me.defaultDateRowTag, true );

						DialogLoading.openWithCallback( function()
						{ 

							var selectedProgram = me.TabularDEObj.getSelectedProgram();


							// Preload program stage data elements data before actual loading of events list.
							me.preloadProgramStageDataElementsData( selectedProgramId );


							// Store the person attributes of the program - to be placed in person table columns (th)
							me.retrieveProgramPersonAttributeData( selectedProgramId
								, function( programTrackedEntityAttributes )
								{
									me.defaultProgram_TEA_Manager.setProgramTrackedEntityAttributes( programTrackedEntityAttributes );
								
									// If the selected program does not have 
									if ( selectedProgram.type == 1 && programTrackedEntityAttributes.length == 0 )
									{
										alert( $( 'span.msg_NoProgramAttributes' ).text() );
										Util.paintAttention( me.defaultProgramTag );
									}
									else
									{
										me.defaultProgramNoteSpanTag.text( '' );
										Util.paintClear( me.defaultProgramTag );

										// Reset PersonList Table Structure/Data and populate the header + one empty row..

										// Reset the list of person  <-- Default Program selection will do this instead.
										me.TabularDEObj.resetMainList();


										// Make the person Main section visible
										//me.setVisibility_MainSectionDiv( true );
									}


									//me.setStatus_PopulateButton();

									DialogLoading.close();

									//me.defaultProgramTag.focus();

									$( 'input:radio[name="period"]')[0].focus();

								}

							);
					

						});

					}
				});
			}


			this.setUp_SearchOptions_Change = function()
			{

				$( '#' + me.searchAllProgramTag.attr( 'id' ) 
					+ ', #' + me.programStatusListTag.attr( 'id' ) 
					+ ', #' + me.listAllPersonHistoricalEventsTag.attr( 'id' ) 
				).change( function() 
				{
					me.performDataRetrieval();
				});
			}


			this.performDataRetrieval = function()
			{
				me.resetMainDataRelated();
			
				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.TabularDEObj.retrieveAndPopulateEvents( me.TabularDEObj.personList.personEvent.mainEventTableTag, function( eventFoundNo )
					{

						me.searchResultMsgRowTag.show();
						me.searchResultMessageTag.text( "Found " + eventFoundNo + " event(s) for period from " + $.format.date( me.getDefaultStartDate(), "dd/MM/yyyy" ) + " to " + $.format.date( me.getDefaultEndDate(), "dd/MM/yyyy" ) + " at " + me.orgUnitNameTag.val() );
						
					});

				}
				else
				{
					me.TabularDEObj.populatePersonData( function( personFoundNo )
					{

						me.searchResultMsgRowTag.show();
						me.searchResultMessageTag.text( "Found " + personFoundNo + " client(s) with at least one event for period from " + $.format.date( me.getDefaultStartDate(), "dd/MM/yyyy" ) + " to " + $.format.date( me.getDefaultEndDate(), "dd/MM/yyyy" ) + " at " + me.orgUnitNameTag.val() );		

					});
				}

				me.setVisibility_MainSectionDiv( true );
			

			}


			this.preloadProgramStageDataElementsData = function( programId )
			{
				// Run below to PRELOAD Data Elements of Stages before the actual person data retrieval.
				//	- Since Below has memory loading - remembers for the loaded data.
				$.each( me.programManager.getProgramStageList( programId ), function( i_programStage, item_programStage )
				{
					me.TabularDEObj.dataInMemory.retrieveProgramStageData( item_programStage.id, function( json_ProgramStage ) 
					{
						// For each data elements, add column.
						$.each( json_ProgramStage.programStageDataElements, function( i_dataElement, item_dataElement ) {

							// Get dataElement info
							me.TabularDEObj.dataInMemory.retrieveDataElement( item_dataElement.dataElement.id, function( json_DataElement )
							{
								if ( json_DataElement.type == "string" && json_DataElement.optionSet != null )
								{
									// Get optionSet values
									me.TabularDEObj.dataInMemory.retrieveOptionSets( json_DataElement.optionSet.id, function( json_OptionSets ) {} );
								}
							});
						});
					});
				});
			}


			// --------------------------
			// On Init Setup Method	

			this.initialSetup = function()
			{				
				// Hide sections initially
				//me.resetSetting_OrgUnitAndBelow();

				me.setUp_SearchOptions_Change();

				// Set Default Date Period Related Initial/Event Set
				me.setDefaultDatePeriod_Related();

				// Set Event for Default Program Change
				me.setDefaultProgramTag_Change();

				// Set OrgUnit Auto Selection
				me.setUp_OrgUnitAutoSelection( me.orgUnitNameTag );
				
				me.retrieveUserAccessOrgUnits( function()
				{
					me.orgUnitRowTag.show();
					Util.paintAttention( me.orgUnitNameTag );
					me.orgUnitNameTag.focus();
				});


				me.setUp_OrgUnitMapClick();
			}

			// --------------------------
			// Run methods

			// Initial Setup Call
			this.initialSetup();
		}


		// -------------------------------------------
		// Class - DefaultProgram_TEA_Manager
		//	- Default Program Tracked Entity Attribues Manager

		function DefaultProgram_TEA_Manager()
		{
			var me = this;
			//this.TabularDEObj = TabularDEObj;
			this.TEAs = []; // Default Program TrackedEntityAttributes;


			// Program selected are handled/stored in ProgramManager

			this.getProgramTrackedEntityAttributes = function()
			{
				return me.TEAs;
			}

			this.setProgramTrackedEntityAttributes = function( attributes )
			{
				me.TEAs = attributes;
			}


			this.getFirstDisplayAttribute = function()
			{
				var firstAttribute;

				// For each person attributes, add the person table column
				$.each( me.TEAs, function( i_attribute, item_attribute )
				{					
					if ( item_attribute.displayInList )
					{
						firstAttribute = item_attribute;
						return false;
					}
				});

				// firstAttribute.id 				
				return firstAttribute;
			}

			this.getInDisplayListCount = function()
			{
				i_attributeCount = 0;

				// For each person attributes, add the person table column
				$.each( me.TEAs, function( i_attribute, item_attribute )
				{
					if ( item_attribute.displayInList )
					{
						i_attributeCount++;
					}
				});

				return i_attributeCount;
			}
		}


		// Class - SearchPanel
		// -------------------------------------------


		// -------------------------------------------
		// Class - ProgramManager
		//			- Populates programs, so that it always holds the list.
		//			- which can be used by program over and over again without retrieveing again.

		function ProgramManager( TabularDEObj, defaultProgramTag )
		{
			var me = this;
			this.TabularDEObj = TabularDEObj;
	
			//this.programList_Full;
			//this.programStageList_Full;
			
			this.programList;  // [ { id:"", name:"", programStageList:[ { id:"", name:"" } ] } ]
			this.selectedProgram;
			this.selectedProgramId;

			this.defaultProgramTag = defaultProgramTag;


			// ----------------------------------
			// Functions

			/*
			this.getSelectedProgramId = function()
			{
				return me.defaultProgramId;
			}
			*/

			this.getDefaultProgramFromListed = function( programId )
			{
				var program;

				if ( Util.checkValue( programId ) && Util.checkValue( me.programList ) )
				{
					for( i = 0; i < me.programList.length; i++ )
					{
						if ( me.programList[i].id == programId )
						{
							program = me.programList[i];
							break;
						}
					}
				}

				return program;
			}

			this.resetSelectedProgram = function()
			{
				delete me.selectedProgramId;
				delete me.selectedProgram;
			}


			this.setSelectedProgram = function( programId )
			{
				if ( programId == '' )
				{
					me.resetSelectedProgram();
				}
				else
				{
					me.selectedProgramId = programId;

					me.selectedProgram = me.getDefaultProgramFromListed( programId );
				}
			}

			this.getSelectedProgramType = function()
			{
				var type;

				if ( me.selectedProgram !== undefined )
				{
					type = me.selectedProgram.type;
				}

				return type;
			}

			this.isCase_MEwR = function()
			{
				var type = me.getSelectedProgramType();

				if ( Util.checkDefined( type ) )
				{
					if ( type == 1 )
					{
						return true;
					}
				}

				return false;
			}

			this.isCase_SEwoR = function()
			{
				var type = me.getSelectedProgramType();

				if ( Util.checkDefined( type ) )
				{
					if ( type == 3 )
					{
						return true;
					}
				}

				return false;
			}

			this.populatePrograms = function( selectTag )
			{
				Util.populateSelect( selectTag, "Program", me.programList );
				//selectTag.val( me.defaultProgramId );
			}

			this.populateProgramStages = function( selectTag, programId )
			{
				Util.populateSelect( selectTag, "ProgramStage", me.getProgramStageList( programId ) );
				//selectTag.val( me.defaultProgramId );
			}
			
			this.getProgramStageList = function( programId )
			{
				var programStages;

				var programList = me.TabularDEObj.dataInMemory.getProgramList_Full();

				// if these is no list for thie programId, generate one and add to the list.
				for( i = 0; i < programList.length; i++ )
				{
					if( programList[i].id == programId )
					{
						programStages = programList[i].programStages;
						break;
					}
				}

				return programStages;
			}

			this.getProgramStageList_FromSource = function( programId, programList )
			{
				var programStages;

				// if these is no list for thie programId, generate one and add to the list.
				for( i = 0; i < programList.length; i++ )
				{
					if( programList[i].id == programId )
					{
						programStages = programList[i].programStages;
						break;
					}
				}

				return programStages;
			}


			this.getProgramList_Full = function()
			{
				// This should be done only after fully loaded or use call back method..
				return me.TabularDEObj.dataInMemory.getProgramList_Full();
			}

			this.getProgramStageList_Full = function()
			{
				return me.TabularDEObj.dataInMemory.getProgramStageList_Full();
			}

			this.getProgramStageData_ById = function( programStageId )
			{
				var programStage;

				var programStages = me.TabularDEObj.dataInMemory.getProgramStageList_Full();

				if ( Util.checkDefined( programStages ) )
				{
					$.each( programStages.programStages, function( i_ps, item_ps )
					{
						if ( item_ps.id == programStageId )
						{
							programStage = item_ps;
							return false;
						}
					});
				}

				return programStage;				
			}


			this.retrieveProgram_ProgramList = function( orgUnitId, populateFunc )
			{

				RESTUtil.getAsynchData( _queryURL_ProgramList + '?orgUnit=' + orgUnitId + '&fields=id,name,type'
					, function ( json_ProgramList )
					{

						QuickLoading.dialogShowAdd( 'programLoading' );

						var programList_Temp = [];

						if ( Util.checkDataExists( json_ProgramList.programs )  )
						{							
							me.TabularDEObj.dataInMemory.retrieveProgramListWithStage_Full( 
								function( json_programListWithStage_Full ) 
								{
									//console.log( 'got Stage and sets' );

									$.each( json_ProgramList.programs, function( i_program, item_program ) 
									{
										programList_Temp.push( { "id": item_program.id, "name":  item_program.name, "type": item_program.type, "programStages":  me.getProgramStageList_FromSource( item_program.id, json_programListWithStage_Full ) } );

										//console.log( 'adding programStage to program' );

									});
		
									QuickLoading.dialogShowRemove( 'programLoading' );

									populateFunc( Util.sortByKey( programList_Temp, "name" ) );
								} 
							);
							
						}
						else
						{
							QuickLoading.dialogShowRemove( 'programLoading' );

							populateFunc( programList_Temp );
						}

					}
					, function() {}
					, function() { QuickLoading.dialogShowAdd( 'programLoading' ); }
					, function() { QuickLoading.dialogShowRemove( 'programLoading' ); }	
				);
			}





			this.loadProgramList = function( orgUnitId )
			{				

				// Reset the programId
				me.resetSelectedProgram();

				// Retrieve the orgUnit filtered program list and programStage list
				me.retrieveProgram_ProgramList( orgUnitId, function( returnData )
				{
					me.programList = returnData;
						
					me.populatePrograms( me.defaultProgramTag );

					Util.paintAttention( me.defaultProgramTag );					
				});				
			}


			// --------------------------
			// Run methods

			this.initialSetup = function( )
			{	
				me.TabularDEObj.dataInMemory.retrieveProgramListWithStage_Full( function() {} );
			}

			// Initial Setup Call
			this.initialSetup( );
		}


		// -------------------------------------------
		// Class - PersonList
		//		Add 'Person' class and 'Event' class to add all the related methods to them.
		//		* Should have created each person object instance.
		//			- Seperate by instance storage and presentation of each
		//		But for now, we keep the event info in each html row
		
		function PersonList( TabularDEObj )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.mainPersonTableTag =  $( '#mainTable_Person' );
			this.mainPersonSectionTag =  $( '#mainSection_Person' );

			this.personAddNewRowTag = $( '#person_addNewRow' );

			this.personDialogForm = new PersonDialogForm( TabularDEObj );

			this.personEvent = new PersonEvent( TabularDEObj, me.mainPersonTableTag );

			this.json_PersonList_EventDateChecked;


			this.attr_PersonRowNo = "personrowno";

			this.attr_doneStages = 'done_stages';

			this.trTemplate_PersonHeaderTr = "<tr class='trPersonHeader'>"
											+ "<th class='blank' width='23px'>&nbsp;</th>"
											+ "</tr>"; 
			
			this.trTemplate_PersonRow = "<td DEID='personDetailToggle'><input type='image' class='personRowDelete' alt='Delete Row' title='Delete Row' src='img/cross.png' style='border: 0px solid;' /><a class='detailToggle' href='' style='display:none;'>[+]</a></td>";
									  //+ "</tr>";

			this.itemTemplate_PersonInputAndInfo = "<input type='text' class='personSelect jq_watermark' placeholder='Search or add new person' size='25' />"
									+ "<button type='button' class='personInfo input_button_round' infoType='" + me.personDialogForm.type_New + "' style='display:none; margin:2px 4px 2px 3px;background-color:#cccccc;' ><span nameId='AddPerson'>Add Person</span></button>"
									+ "<button type='button' class='personInfo input_button_round' infoType='" + me.personDialogForm.type_Exist + "' style='display:none; margin:2px 4px 2px 3px;background-color:#cccccc;' ><span nameId='UpdatePerson'>Update Person</span></button>"
									+ "<img class='personInfoImg' src='img/info.png' alt='person Info' title='Update Person' style='display:none;border: 0px;' />"
									+ "<span class='personEventCountSec' style='display:none;color:#585858;font-size:9px;font-style:italic;'>&nbsp;<span class='personEventCount'></span></span>";

			this.trTemplate_PersonDetail = "<td class='blank' colspan='0'></td>";


			this.trGeneratedTemplate = "";

			// ----------------------------------
			// Functions

			this.hideMainSections = function()
			{
				me.mainPersonSectionTag.hide();
				me.personEvent.mainEventSectionTag.hide();
			}

			this.showMainSection = function()
			{
				if ( me.TabularDEObj.isCase_MEwR() )
				{
					me.mainPersonSectionTag.show( 200 );
				}
				else if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.personEvent.mainEventSectionTag.show( 200 );
				}
			}


			this.resetMainList = function()
			{
				if ( me.TabularDEObj.isCase_MEwR() )
				{
					me.resetPersonList();
				}
				else if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.personEvent.resetEventList();
				}
			}

			this.clearPersonList = function( tableTag )
			{
				me.clearPersonTableRows( tableTag );

				// even clear headers - since we need to regenerate based on changed program attributes (displayed ones)
				tableTag.find( "tr" ).remove();
			}


			this.resetPersonList = function()
			{
				me.clearPersonList( me.mainPersonTableTag );

				// Remove the saved Tr Template
				me.trGeneratedTemplate = "";

				// Add Header 
				me.createPersonTableHeaders( me.TabularDEObj.getProgramTrackedEntityAttributes() );

				me.addInitialRow();
			}

			this.clearPersonTableRows = function( tableTag )
			{
				// Clear all the person list & their events
				tableTag.find( ".tbStyle_PersonDetail" ).remove();
				tableTag.find( "tr.trPerson, tr.trPersonDetail" ).remove();  // since we now have dynamic header
			}

			this.addInitialRow = function()
			{
				// TODO: call this method from a class...
				// Initial first blank row add
				me.addNewLastRow_Person( me.mainPersonTableTag );
			}

			this.getNewPersonRowCount = function( mainPersonTable )
			{
				var rowCount;

				var lastPersonRow = mainPersonTable.find( "tr.trPerson:last" );

				if ( lastPersonRow.length == 0 )
				{
					rowCount = 1;
				}
				else
				{
					var rowCount = parseInt( lastPersonRow.attr( me.attr_PersonRowNo ) ) + 1;
				}

				return rowCount;
			}


			// ---------
			// Set Person Table Header/Row/Data Related

			this.createPersonTableHeaders = function( programTrackedEntityAttributes )
			{
				
				me.mainPersonTableTag.append( me.trTemplate_PersonHeaderTr );

				var personTableHeader = me.mainPersonTableTag.find( 'tr.trPersonHeader' );

				var i_attributeCount = 0;

				// For each person attributes, add the person table column
				$.each( programTrackedEntityAttributes, function( i_attribute, item_attribute )
				{
					if ( item_attribute.displayInList )
					{
						personTableHeader.append( "<th class='orig' type='header_attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "'>" + item_attribute.name + "</th>" );
						// "' style='max-width: 140px;'

						i_attributeCount++;
					}
				});


				// Add the last org info - the org the person belongs to. ID gets populated later
				personTableHeader.append( "<th class='orig' type='homeUnit' orguintid=''>Home Unit</th>" );
			}


			this.createPersonTableRows = function( mainPersonTable, programTrackedEntityAttributes )
			{

				var trString = "";

				if ( Util.checkValue( me.trGeneratedTemplate ) )
				{
					trString = me.trGeneratedTemplate;
				}
				else
				{
	
					trString = me.trTemplate_PersonRow;

					var i_attributeCount = 0;

					// For each person attributes, add the person table column
					$.each( programTrackedEntityAttributes, function( i_attribute, item_attribute )
					{
						
						if ( item_attribute.displayInList )
						{

							var tdStr = "";

							if ( i_attributeCount == 0 )
							{
								tdStr = "<td type='attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "' style='white-space: nowrap;' class='tdPersonInfo'>" + me.itemTemplate_PersonInputAndInfo + "</td>";

								// Enter text here for search or ...
							}
							else
							{
								tdStr = "<td type='attribute_" + i_attributeCount + "' attributeid='" + item_attribute.id + "' class='tdPersonInfo'></td>";
							}
							
							trString += tdStr;

							i_attributeCount++;
						}
					});


					// Add the last org info - the org the person belongs to. ID gets populated later
					trString += "<td type='homeUnit'></td>" ;

					me.trGeneratedTemplate = trString;
				}


				// Append the generated Tr info - * Use 'document.createElement()' to speed up.
				mainPersonTable.append( $( document.createElement( "tr" ) ).attr( 'class', 'trPerson' ).attr( 'done_stages', '' ).append( trString ) );
				
				
				var lastPersonRow = mainPersonTable.find( 'tr.trPerson:last' );

				// Add row delete event handler
				
				lastPersonRow.find( '.personRowDelete').click( function() 
				{
					var trCurrent = $( this ).closest( 'tr' );

					var nextFocusTag = Util.getNextRowFocus_Person( trCurrent );

					Util.setRowRemoval( trCurrent );

					if ( nextFocusTag !== undefined )
					{
						nextFocusTag.focus();
					}

				});

				return lastPersonRow;
			}


			this.populatePersonAttirbutesToRow = function( trCurrent, attributes )
			{
				if ( attributes !== undefined )
				{

					$.each( attributes, function( i_attribute, item_attribute )
					{

						var currentTd = trCurrent.find( "td[attributeid='" + item_attribute.attribute + "']" );

						if ( currentTd.length > 0 )
						{
							var inputField = currentTd.find( 'input' );

							var attributeValue = Util.getFormattedAttributeValue( item_attribute );

							if ( inputField.length > 0 )
							{
								inputField.val( attributeValue );
							}
							else
							{
								// TODO: Need to get the display value of each attribue..
								currentTd.html( '<span>' + attributeValue + '</span>' );
							}
						}
						
					});
				}
			}

			// Set Person Table Header/Row/Data Related
			// ---------


			// -- Row Manipulation (Add/Remove) ----
			this.addNewLastRow_Person = function( mainPersonTable )
			{
				var newRowCount = me.getNewPersonRowCount( mainPersonTable );

				// Add 2 Rows (Person + PersonDetail)
				// Person Row Add
				var trCurrent = me.addPersonRow( mainPersonTable, newRowCount );

				// --- Set events ---
				me.personAutoSelection( trCurrent.find( '.personSelect' ) );
				
								
				// Person Detail Row Add - empty row		
				var trPersonDetail = me.addPersonDetailRow_Empty( mainPersonTable, trCurrent );


				// Language translate for realtime created button text.
				me.TabularDEObj.languageSetting.setTranslation_FromSource( trCurrent, $( '#translationTagDiv' ) );

				return trCurrent;
			}


			this.addPersonRow = function( mainPersonTable, newRowCount )
			{
				
				var lastPersonRow = me.createPersonTableRows( mainPersonTable, me.TabularDEObj.getProgramTrackedEntityAttributes() );

				lastPersonRow.attr( me.attr_PersonRowNo, newRowCount );

				// Add dialog click event
				lastPersonRow.find( ".personInfo" ).hide().click( function() {

					// Check the Default Program selection.
					// For new user case, alert if not selected
					var formType = $( this ).attr( "infoType" );

					var trCurrent = $( this ).closest("tr");
					var defaultProgramId = me.TabularDEObj.getSelectedProgramId();

					if ( formType == me.personDialogForm.type_New && !Util.checkValue( defaultProgramId ) )
					{
						// If the person form Type is 'New', but default Program is not selected,
						// Ask users to select one.
						alert( $( 'span.msg_SelectDefaultProgram' ).text() );
					}
					else
					{
						DialogLoading.openWithCallback( 
							function()
							{ 
								if ( me.personDialogForm.setupForm( trCurrent, formType ) )
								{
								
									me.personDialogForm.openForm( trCurrent );
								}

								DialogLoading.close();
							}
						);
					}
				});

				return lastPersonRow;
			}


			this.addPersonDetailRow_Empty = function( mainPersonTable, trPerson )
			{
				mainPersonTable.append( $( document.createElement( "tr" ) ).attr( 'class', 'trPersonDetail' ).attr( 'style', 'display:none;' ).append( me.trTemplate_PersonDetail ) );


				var personDetailRowCurrent = mainPersonTable.find( 'tr.trPersonDetail:last' );

				var personTableColumnNo = me.TabularDEObj.getInDisplayListCount() + 2;

				personDetailRowCurrent.find( 'td.blank' ).attr( 'colspan', personTableColumnNo );


				return personDetailRowCurrent;
			}


			// Functions
			// ----------------------------------


			// -- Person Auto Selected Related -------------------
			// ---------------------------------------------------

			this.personAutoSelection = function( el )
			{
				var trPersonTable = el.closest( "table" );
				var trCurrent = el.closest( "tr.trPerson" );

				el.autocomplete( {
					source: 
						function(request, response) 
						{

							me.clearColor_duplicatePersonWarning( trPersonTable );

							//DialogLoading.enable( false );

							//var trCurrent = el.closest("tr");

							// Clear the info
							me.setPersonInfoRow( trCurrent );

							// Hide the person detail row if expanded.
							Util.toggleTarget( trCurrent.find( '.detailToggle' ), trCurrent.next(), false );

							var json_persons_new = new Array();


							if ( request.term.length >= 2 )
							{

								var attribute0_id = me.getAttributeIdIfExists( trCurrent, 'attribute_0' );

								if ( !Util.checkValue( attribute0_id ) ) 
								{
									alert( $( 'span.msg_ProgramAttributeAtLeast' ).text() );
								}
								else
								{

									// ou Added for the limited feature..
									var requestUrl = _queryURL_PersonQuery + ".json?attribute=" + attribute0_id + ":LIKE:" + request.term + "&ouMode=DESCENDANTS&ou=" + me.TabularDEObj.searchPanel.getCountryId();

									// Step 1. Search Person  --- TODO: do the loading message?
									var deferredAction_getPerons = RESTUtil.getAsynchData( requestUrl );

									
									$.when( deferredAction_getPerons ).then( function( json_Persons )
									{
										if( Util.checkDataExists( json_Persons.rows ) )
										{
											// 'OKC89cWPeUo' is the passed-in attribute
											var attribute0_index = me.getHeaderAttributeIndex( json_Persons.headers, attribute0_id );

											var attribute1_id = me.getAttributeIdIfExists( trCurrent, 'attribute_1' );
											var attribute2_id = me.getAttributeIdIfExists( trCurrent, 'attribute_2' );

											var attribute1_index = me.getHeaderAttributeIndex( json_Persons.headers, attribute1_id );

											var attribute2_index = me.getHeaderAttributeIndex( json_Persons.headers, attribute2_id );

											$.each( json_Persons.rows, function( i, item_Person ) {

												// Get 1st and 2nd id from current Tr..
												var attribute0_value = item_Person[ attribute0_index ]
												var attributesLongDesc = attribute0_value; 

												if ( Util.checkValue( attribute1_index ) ) 
												{
													attributesLongDesc += ', ' + item_Person[ attribute1_index ];
												}

												if ( Util.checkValue( attribute2_index ) ) 
												{
													attributesLongDesc += ', ' + item_Person[ attribute2_index ];
												}

												json_persons_new.push( { "id": item_Person[0], "label": attributesLongDesc, "value": attribute0_value } );  // , "person": item_Person 

											});
										}

										response( Util.sortByKey( json_persons_new, 'label' ) );

									});
								}	
							}
							else
							{
								response( json_persons_new );
							}
						}
					,
					minLength: 0,
					delay: 500,
					select: 
						function( event, ui ) {

							if( me.checkPersonExistInList( ui.item.id, el, trPersonTable ) )
							{
								$( this ).val( '' );
								return false;
							}
							else
							{
								DialogLoading.openWithCallback( 
									function()
									{ 
										me.getPersonById( ui.item.id, function( item_Person )
										{
											me.setPersonInfoRow( trCurrent, item_Person );

											me.populateAndSet_PersonDetailSection( trCurrent, trCurrent.next(), item_Person );

											DialogLoading.close();


											// Open up the Detail Part
											Util.toggleTarget( trCurrent.find( '.detailToggle' ), trCurrent.next() );

										});											
									}
								);
							}
						}
				} );

			}

			this.getPersonById = function( personId, execFunc )
			{
				PersonUtil.getPersonByID_Async( personId, function( item_person )
				{
					execFunc( item_person );
				});
			}


			this.getPerson_WithDoneStage = function( personId, execFunc )
			{
				PersonUtil.getPersonByID_Async( personId, function( item_person )
				{
					me.retrieveAndSetDoneProgramStages( item_person, function()
					{
						execFunc( item_person );
					});
				});
			}

			this.checkPersonExistInList = function( personId, currentInputTag, tableTag )
			{
				var existsAlready = false;

				var foundPersonTrTag = tableTag.find( 'tr.trPerson[uid="' + personId + '"]' );

				if ( foundPersonTrTag.length > 0 )
				{
					//Util.paintWarning( currentInputTag );
					Util.paintAttention( foundPersonTrTag.find( 'input.personSelect' ) );

					alert( $( 'span.msg_SamePersonInList' ).text() );

					existsAlready = true;
				}

				return existsAlready;
			}


			this.clearColor_duplicatePersonWarning = function( tableTag )
			{
				Util.paintClear( tableTag.find( 'input.personSelect' ) );
			}


			this.getAttributeIdIfExists = function( trCurrent, attributeNo )
			{
				var attributeId = '';

				var tdAttribute = trCurrent.find( "td[type='" + attributeNo + "']" );
				if ( tdAttribute.length == 1 )
				{
					attributeId = tdAttribute.attr( 'attributeid' );
				}
				
				return attributeId;
			}

			this.getAttributeValueById = function( attributes, attributeId )
			{
				var attributeValue = "";

				for (i = 0; i < attributes.length ;i++ )
				{
					if ( attributes[i].attribute == attributeId )
					{
						attributeValue = Util.getFormattedAttributeValue( attributes[i] );

						break;
					}
				}

				return attributeValue;
			}

			this.getHeaderAttributeIndex = function( headers, attributeId )
			{
				var foundIndex;

				if ( attributeId != "" )
				{
					for ( i = 0; i < headers.length; i++ )
					{
						if ( headers[i].name == attributeId )
						{
							foundIndex = i;
							break;
						}
					}
				}

				return foundIndex;
			}



			this.setPersonInfoRow = function( trCurrent, item_Person )
			{

				// Initialize person event count
				me.setPersonEventCount( trCurrent );

				// Hide the buttons and images
				trCurrent.find( ".personInfoImg,.personInfo" ).hide();


				if( Util.checkDefined( item_Person ) )
				{
					var personId = item_Person.trackedEntityInstance;

					trCurrent.attr( 'uid', personId );
					trCurrent.next().attr( 'uid', personId );

					// set 'doneStage' attribute data
					if ( item_Person.doneStages !== undefined )
					{
						trCurrent.attr( me.attr_doneStages, item_Person.doneStages );
					}


					// Display Person Info Image Button
					trCurrent.find( ".personInfoImg" ).show().attr( "src", "img/info.png" );
					trCurrent.find( ".personInfo[infoType='" + me.personDialogForm.type_Exist + "']" ).show();


					// Populate the person Attribute info.
					me.populatePersonAttirbutesToRow( trCurrent, item_Person.attributes );


					// Set person Home Unit - org Unit
					if ( Util.checkDefined( item_Person.orgUnit ) )
					{
						me.TabularDEObj.dataInMemory.retrieveOrgUnitName( item_Person.orgUnit, function( json_OrgUnit )
						{
							trCurrent.find( "td[type='homeUnit']" ).text( json_OrgUnit.name );
						});
					}


					// Hide row delete
					trCurrent.find( '.personRowDelete' ).hide();

					var trDetailRow = trCurrent.next();
				

					// When toggling anchor, show/hide the event list
					trCurrent.find( '.detailToggle' ).show().off( 'click' ).click( function() {
						
						Util.toggleTarget( $( this ), trDetailRow );


						// If event section is not setup/populated, create Table and load data, event setup
						var populateStatus = trDetailRow.attr( 'populateStatus' );

						// If it is not populated already, add table and populate event
						if ( !( Util.checkValue( populateStatus ) && populateStatus == 'Y' ) )
						{	
							// Populate table.
							me.populateAndSet_PersonDetailSection( trCurrent, trDetailRow, item_Person );
						}
						
						return false;
					} );


					// Set up the event count on the row
					if ( Util.checkDefined( item_Person.events ) )
					{
						me.setPersonEventCount( trCurrent, item_Person.events.length );
					}

					/*
					// TODO: Currently do not use this, but when opening the events, we need to use this?
					if( Util.checkDefined( json_Events_Data ) )
					{
						me.personEvent.populateEvents( trCurrent, trDetailRow.find( ".tbStyle_PersonDetail" ), json_Events_Data );
					}
					*/

				}
				else
				{
					// Clear person data
					// Attributes
					trCurrent.find( "td[type^='attribute_']" ).each( function()
					{
						var tdTag = $( this );
						if ( tdTag.attr( 'type' ) != 'attribute_0' )
						{
							tdTag.text( '' );
						}
					});

					// Remove 'doneStage' data
					trCurrent.attr( me.attr_doneStages, '' );


					// Home Unit
					trCurrent.find( "td[type='homeUnit']" ).text( '' );


					if( trCurrent.find( ".personSelect" ).val() == "" )
					{
						trCurrent.find( ".personInfoImg" ).hide();
					}
					else
					{
						trCurrent.find( ".personInfoImg" ).show().attr( "src", "img/info_red.png" ).attr( "title", "Add New Entity" );

						trCurrent.find( ".personInfo[infoType='" + me.personDialogForm.type_New + "']" ).show();
					}


					// Show row delete
					trCurrent.find( ".personRowDelete" ).show();

					// Add Person Detail Toggle Anchor
					trCurrent.find( ".detailToggle" ).hide();
					
					// Add Event to the created toggle anchor
					//trCurrent.find(".detailToggle").click( personDetailToggle );
				}
			}


			this.setPersonEventCount = function( trPersonRow, count )
			{
				var personEventCountSecTag = trPersonRow.find( '.personEventCountSec' );
				var personEventCountTag = trPersonRow.find( '.personEventCount' );

				if ( count === undefined )
				{
					// Initialize
					personEventCountSecTag.hide();
					personEventCountTag.text( '' );
				}
				else
				{
					// Initialize
					personEventCountSecTag.show();
					personEventCountTag.text( 'E' + count ).attr( 'title', 'Event Count' );
				}
			}


			this.populateAndSet_PersonDetailSection = function( trPersonRow, trDetailRow, item_Person )
			{
				var tdDetailSection = trDetailRow.find( 'td.blank' );
				var personId = item_Person.trackedEntityInstance;


				tdDetailSection.html( '' ).append( "<div class='divPersonDetail'><table class='tbStyle_PersonDetail'>"
											+ "<tr class='trEventHead'>"
												+ "<th class='orig'><span nameId='EventTableHeader_Date_OrgUnit'>Date / OrgUnit</span></th>"
												+ "<th class='orig'><span nameId='EventTableHeader_Program_Stage'>Program / Stage</span></th>"
												+ "<th class='orig' align='center'><span nameId='EventTableHeader_Status'>Status</span></th>"
												+ "<th class='orig' type='delete'>&nbsp;</th>"
											+ "</tr>"
										+ "</table>"
										+ "<div class='divAddEvent' style='margin:2px 1px 2px 20px;'><span><button type='button' class='personEvent_addNewRow input_button' style='display:none;'><span nameId='AddNewEventRow'>Add Event</span></button></span><span style='width:24px;'>&nbsp;</span></div></div>" );


				var tbEvent = trDetailRow.find( '.tbStyle_PersonDetail' );
				var addNewEventRowButton = trDetailRow.find( '.personEvent_addNewRow' );


				// Set events on Person Detail seciton
				me.setEvents_PersonDetailRow( trPersonRow, tbEvent, addNewEventRowButton );


				// Populate the event data..
				var divPersonDetailTag = tdDetailSection.find( '.divPersonDetail' );
				

				me.personEvent.populateEventsByPersonId( personId, trPersonRow, divPersonDetailTag, function( json_Events )
				{
					
					// Show 'Add new event' button if Active program
					if ( me.TabularDEObj.getSearchProgramStatus() == _status_ACTIVE )
					{
						addNewEventRowButton.show();
					}

					// * After populating event data, Set 'DoneStage'
					me.setDoneStageRelated( item_Person, trPersonRow, function( doneStages )
					{
						// For already populated events case, if there is 'add new'
						// row added, remove the stage.
						me.personEvent.removeFromStageList( divPersonDetailTag.find( 'select.eventStage' ), doneStages );					
					});


					// Set event count update
					me.setPersonEventCount( trPersonRow, json_Events.length );

				});	

				// Set as populated
				trDetailRow.attr( 'populateStatus', 'Y' );			
			}


			// ------ Done Stages Related - BEGIN ------

			this.setDoneStageRelated = function( item_Person, trPersonRow, execFunc )
			{
				var divAddEvent = trPersonRow.next().find( ".divAddEvent" );

				// Disable the row 'add Event' button.. Initially..
				FormUtil.setTagAsWait( divAddEvent );

				// For Person, do event search for 'done' program stage (for non-repeatable)
				me.retrieveAndSetDoneProgramStages( item_Person, function()
				{
					if ( item_Person.doneStages !== undefined )
					{
						trPersonRow.attr( me.attr_doneStages, item_Person.doneStages );
					
						execFunc( trPersonRow.attr( me.attr_doneStages ) );
					}

					// Enable the row 'add Event' button..
					FormUtil.setTagAsWait_Clear( divAddEvent );
				});
			}

			this.addTo_DoneStage = function( trPersonRow, stageId )
			{
				var doneStages_Existing = trPersonRow.attr( me.attr_doneStages );
				
				if ( doneStages_Existing === undefined )
				{
					trPersonRow.attr( me.attr_doneStages, stageId + ';' );
				}
				else
				{
					trPersonRow.attr( me.attr_doneStages, doneStages_Existing + stageId + ';' );
				}
			}


			// ------ Done Stages Related - END ------


			this.setEvents_PersonDetailRow = function( trPerson, tbEvent, addNewEventRowButton )
			{
				
				//me.personEvent.addNewLastRow_Event( trPerson, tableCurrent, me.TabularDEObj.getSelectedProgramId() );

				// Set event handler for 'add new event row' button
				addNewEventRowButton.click( function() 
				{ 
					var eventDate = me.personEvent.addNewLastRow_Event( trPerson, tbEvent, me.TabularDEObj.getSelectedProgramId() );

					eventDate.focus();
				});
			}


			// -----
			// Populate Person Method.

			this.populatePersonData = function( returnFunc )
			{
				var tableTag = me.mainPersonTableTag;

				// Step 1. Clear the person/event data table
				me.clearPersonTableRows( tableTag );

					
				// Step 2. Retrieve person and events.
				me.TabularDEObj.retreivePersonListWithEvents( function( json_PersonEventsList )
				{

					// If there were no event, simply add one empty row.
					if ( json_PersonEventsList.length == 0 )
					{
						me.addNewLastRow_Person( tableTag );
						returnFunc( 0 );
					}
					else
					{
						// Retrieve each person information, sort them by first attribute, and display as person row.

						me.updatePersonWithDetails( json_PersonEventsList, function( json_PersonEventsList_Details )
						{

							// Step 3. Sort the person by the first attribute
							var firstAttribute = me.TabularDEObj.getFirstDisplayAttribute();

							PersonUtil.setPersonWithFirstAttributeData( json_PersonEventsList_Details, firstAttribute.id );

							var personEventObjList_Sorted = Util.sortByKey( json_PersonEventsList_Details, PersonUtil.primaryAttributeVal );


							// Step 4. With person and person events within it, popuplate/display them..
							$.each( personEventObjList_Sorted, function( i_person, item_person ) 
							{
								var trPersonLast = me.addNewLastRow_Person( tableTag );

								// Do not populate event at this time.
								me.setPersonInfoRow( trPersonLast, item_person ); //, item_person.events );

							});


							// Last emtpy row add
							me.addNewLastRow_Person( tableTag );
								
							returnFunc( personEventObjList_Sorted.length );

						});
					}

				}
				, function( failed_Message )
				{
					returnFunc( 0 );

					alert( $( 'span.msg_EventRetrievalFailed' ).text() + '\n\n Error: ' + JSON.stringify( failed_Message ) );
				});

			}


			this.updatePersonWithDetails = function( json_PersonEventsList, execFunc )
			{
				var personTotal = json_PersonEventsList.length;
				var count = 0;

				$.each( json_PersonEventsList, function( i_person, item_person ) 
				{
					RESTUtil.getAsynchData( _queryURL_PersonQuery + "/" + item_person.trackedEntityInstance + ".json"
					, function( json_Person )
					{
						Util.copyProperties( json_Person, item_person );
					}
					, function() {}
					, DialogLoading.open
					, function() 
					{
						DialogLoading.close();

						count++;

						if ( count == personTotal )
						{
							execFunc( json_PersonEventsList );
						}						
					}
					);
				});
			}

			this.retrievePersonAndPopulateInfo = function( personRowsTag, personCount )
			{
				personRowsTag.each( function( i )
				{
					var trPersonTag = $( this );
					var personUid = trPersonTag.attr( 'uid' );

					if ( Util.checkValue( personUid ) )
					{
						RESTUtil.getAsynchData( _queryURL_PersonQuery + "/" + personUid + ".json"
						, function( json_Person )
						{
							if ( Util.checkDefined( json_Person ) ) 
							{
								// Populate the row with person obj.
								me.setPersonInfoRow( trPersonTag, json_Person );

								FormUtil.setTagAsWait_Clear( trPersonTag );
							}
						}
						, function() 
						{
							console.log( 'Failed to retrieve person data: ' + personUid );
						}
						);
					}

				});




			}


			// -- Person Auto Selected Related -------------------
			// ---------------------------------------------------


			this.programEnroll = function( personId, programId, eventDateInFormat, newlyEnrolledAction, successAction, failAction )
			{				
				// If already enrolled or successfully enrolled, perform 'execFunc'
				// Set enrolled to 'true' if enrolled just now.

				me.checkEnroll( personId, programId
					, function()
					{
						if ( successAction !== undefined ) successAction();
					}
					, function()
					{
						me.newEnroll( personId, programId, eventDateInFormat, newlyEnrolledAction, successAction, failAction );
					}
				);

			}


			this.checkEnroll = function( personId, programId, enrolledAction, notEnrolledAction )
			{
				// Check Enrollment first.
				RESTUtil.getAsynchData( _queryURL_ProgramEnrollmentQuery + '?trackedEntityInstance=' + personId + '&program=' + programId
					, function( json_ProgramEnrollment ) 
					{ 
						if ( Util.checkDefined( json_ProgramEnrollment ) 
							&& Util.checkDataExists( json_ProgramEnrollment.enrollments ) )
						{

							if ( Util.checkData_WithPropertyVal( json_ProgramEnrollment.enrollments, "status", _status_ACTIVE ) )
							{
								enrolledAction();
							}
							else
							{
								if ( me.TabularDEObj.getSelectedProgram().onlyEnrollOnce )
								{
									alert( $( 'span.msg_CanNotEnrol_PreviousEnroll' ).text() );
								}
								else
								{
									notEnrolledAction();
								}
							}
						}
						else
						{
							notEnrolledAction();
						}
					}
					, notEnrolledAction
				);
			}

			this.newEnroll = function( personId, programId, eventDateInFormat, newlyEnrolledAction, successAction, failAction )
			{
				// Enroll the user
				var json_Enroll = { "trackedEntityInstance": personId, "program": programId, "dateOfEnrollment": eventDateInFormat } //, "dateOfIncident": eventDateInFormat };

				RESTUtil.submitData( json_Enroll, _queryURL_ProgramEnrollmentSubmit, "POST"
					, function( returnData )
					{
						if ( newlyEnrolledAction !== undefined ) newlyEnrolledAction( returnData );
						if ( successAction !== undefined ) successAction();
					}
					, function( returnData )
					{
						if ( failAction !== undefined ) failAction( returnData );
					}
				);
			}

			this.retrieveAndSetDoneProgramStages = function( item_person, execFunc )
			{
				// If the person has non-repeatable stages that are 'done', 
				// mark the stage, so that this person can not add that stage anymore.

				var programStageList = me.TabularDEObj.getProgramStageList( me.TabularDEObj.getSelectedProgramId() );

				var deferredArrActions_checkStages = [];

				$.each( programStageList, function( i_programStage, item_programStage )
				{
					if ( !item_programStage.repeatable )
					{
						deferredArrActions_checkStages.push( 
							RESTUtil.getAsynchData( me.TabularDEObj.getEventQueryBaseUrl() 
								+ '&programStage=' + item_programStage.id 
								+ '&trackedEntityInstance=' + item_person.trackedEntityInstance
							, function( eventsRetrieved )
							{
								if ( Util.checkValue( eventsRetrieved.events ) ) 
								{
									if ( item_person.doneStages === undefined )
									{
										item_person.doneStages = item_programStage.id + ";";
									}
									else
									{
										item_person.doneStages +=  item_programStage.id + ";";
									}
								}
							}
							, function() 
							{ 
								console.log( 'Failed - On retrieveAndSetDoneProgramStages.  Stage: ' + item_programStage.id + ', TrackedEntityInstance: ' + item_person.trackedEntityInstance ); 
							} ) );	
					}
				});
					

				$.when.apply($, deferredArrActions_checkStages ).then( function( ) 
				{
					execFunc();
				});		
			}


			this.setupAddNewPersonRow = function()
			{
				me.personAddNewRowTag.click( function() 
				{
					var trPersonLast = me.addNewLastRow_Person( me.mainPersonTableTag );

					trPersonLast.find( '.personSelect' ).focus();
				});
			}

			// Initial Setup Call
			this.initialSetup = function()
			{				
				me.setupAddNewPersonRow();
			}

			// --------------------------
			// Run methods

			// Initial Setup Call
			this.initialSetup();
		}

		// PersonList Class
		// -------------------------------------------


		// -------------------------------------------
		// Class - PersonEvent

		function PersonEvent( TabularDEObj, mainPersonTableTag )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.mainPersonTableTag =  mainPersonTableTag;

			this.mainEventTableTag =  $( '#mainTable_Event' );
			this.mainEventSectionTag =  $( '#mainSection_Event' );


			this.attr_EventRowNo = "eventrowno";

			this.trTemplate_EventRow = "<td class='orig'><input type='text' class='eventDate datepicker' caltype='upToToday' size='12'><br><span class='eventOrgUnit'></span></td>"
											+ "<td class='orig'><div><select class='eventProgram' style='margin: 1px 1px;display:none;' />"
											+	"<div class='eventProgramDiv divReadOnly'></div></div>"
											+	"<div><select class='eventStage' style='margin: 1px 1px;'/><div class='eventStageDiv  divReadOnly'></div></div><div><button class='eventCreate input_button_round' style='font-size: 9px; -webkit-border-radius: 9px; border-radius: 9px;' >&nbsp;&nbsp;&nbsp;&nbsp;<span nameId='CreateEvent'>Create</span>&nbsp;&nbsp;&nbsp;&nbsp;</button></div></td>"
											+ "<td class='orig' align='center'><span class='eventStatus'></span></td>"
											+ "<td class='orig tdEventDelete'><input type='image' class='eventRowDelete' alt='Delete Row' title='Delete Row' src='img/cross.png' style='border: 0px solid;' /><input type='image' class='eventDelete' alt='Delete Event' title='Delete Event' src='img/cross.png' style='display:none; border: 0px solid;' /></td>";


			this.buttonTemplate_Complete = "<button type='button' class='eventComplete input_button_round' style='display:none;'><span nameId='CompleteEvent'>Complete</span></button>";

			this.thTemplate_CompleteButton = "<th class='added' colcount='' type='completed_button'>&nbsp;</th>";
			this.tdTemplate_CompleteButton = "<td class='added' type='completed_button' colcount=''>" + this.buttonTemplate_Complete + "</td>";

			// ----------------------------------------------------------------------
			// Event List without Person List related

			this.clearEventList = function()
			{
				me.mainEventTableTag.find( "tr.trEventData" ).remove();
				me.mainEventTableTag.find( "tr.trEventHead th.added" ).remove();
			}

			this.resetEventList = function( )
			{
				me.clearEventList();

				me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );

				me.mainEventSectionTag.find( '.personEvent_addNewRow' ).click( function() 
				{ 
					var eventDate = me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );

					eventDate.focus();
				});
			}

			// Event List without Person List related
			// ----------------------------------------------------------------------


			this.getNewPersonEventRowCount = function( tableCurrent )
			{
				var rowCount;

				var lastRow = tableCurrent.find( "tr.trEventData:last" );

				if ( lastRow.length == 0 )
				{
					rowCount = 1;
				}
				else
				{
					var rowCount = parseInt( lastRow.attr( me.attr_EventRowNo ) ) + 1;
				}

				return rowCount;
			}


			this.setEventCreateButtonEnable = function( trCurrent )
			{
				var eventDate = trCurrent.find( ".eventDate" );
				var eventStage = trCurrent.find( ".eventStage" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );

				// Disable the button initially
				Util.disableTag( eventCreateTag, true );
		
				if ( Util.checkCalendarDateStrFormat( eventDate.val() ) )
				{
					if ( me.TabularDEObj.isCase_SEwoR() || eventStage.val() != '' )
					{
						Util.disableTag( eventCreateTag, false );
					}
				}
			}


			this.addNewLastRow_Event = function( trPerson, tableCurrent, programId )
			{
				var newRowCount = me.getNewPersonEventRowCount( tableCurrent );

				// Person Row Add
				var trCurrent = me.addEventRow( newRowCount, tableCurrent );
				var trHead = tableCurrent.find( "tr.trEventHead:first" );

				// Populate Program and Stage
				var eventDate = trCurrent.find( ".eventDate" );
				var eventProgram = trCurrent.find( ".eventProgram" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStage = trCurrent.find( ".eventStage" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );


				// Event Date Datepicker setup
				//   - Initially, event date is empty and program stage is disabled.
				//   - When event date is selected, enable program stage and set focus on that stage.
				Util.setupDatePicker( eventDate
					, function() 
					{ 
						
						Util.disableTag( eventStage, true );

						if ( Util.checkCalendarDateStrFormat( eventDate.val() ) )
						{
							Util.disableTag( eventStage, false );
						}


						me.setEventCreateButtonEnable( trCurrent );


						if ( me.TabularDEObj.isCase_SEwoR() )
						{
							eventCreateTag.focus();
						}
						else
						{
							eventStage.focus(); 
						}
					}
					, undefined
					,"upToToday"
				);


				// For program, set is as display only. 
				Util.selectOption_WithOptionalInsert( eventProgram, programId, me.TabularDEObj.getProgramList_Full() );
				eventProgram.hide();
				eventProgramDiv.show().html( eventProgram.find( 'option:selected' ).text() );
				//Util.paintResult( eventProgramDiv, true );


				// Populate Stage list.
				if( Util.checkValue( eventProgram.val() ) )
				{
					me.TabularDEObj.populateProgramStages( eventStage, eventProgram.val() );

					// If MEwR case, see if person has done stage list.
					// If there is, remove them from the programStage selection.
					if ( trPerson !== undefined )
					{
						var doneStages = trPerson.attr( me.TabularDEObj.personList.attr_doneStages );

						me.removeFromStageList( eventStage, doneStages );
					}

					// Disable the ProgramStage - Initially
					Util.disableTag( eventStage, true );					
				}

				// Set the event button Disable - initially
				me.setEventCreateButtonEnable( trCurrent );


				// On stage change, check stage value and event date value.
				eventStage.change( function() 
				{
					me.setEventCreateButtonEnable( trCurrent );

					eventStage.focus();
				});



				// If Single Event without Registration case, hide program & stage
				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					eventProgram.closest( 'div' ).hide();
					eventStage.closest( 'div' ).hide();
					eventStage.val( eventStage.find( 'option:nth-child(2)' ).val() );
				}


				eventCreateTag.click( function() 
				{					
					var programStageSelected = eventStage.val();

					// Check eventDate and eventStage value
					if ( Util.checkCalendarDateStrFormat( eventDate.val() ) && programStageSelected != ''  )
					{

						// 1. Generate the event and put the event id into the ..
						me.eventCreate( trCurrent
						, function( eventId, eventStatus )
						{
							// Check for program stage 'non-repeatableness'
							// and add to 'DontStage' is applicable.
							var programStageData_Selected = me.TabularDEObj.getProgramStageData_ById( programStageSelected );

							if ( me.TabularDEObj.isCase_MEwR() && Util.checkDefined( programStageData_Selected ) && Util.checkDefined( programStageData_Selected.repeatable ) &&  !programStageData_Selected.repeatable )
							{
								// Add this uid to the doneStage
								me.TabularDEObj.addTo_DoneStage( trPerson, programStageSelected );
							}


							eventStage.attr( "selectedProgramStage", programStageSelected ); 

							// 2. Populate the data element columns
							me.populateEventColumns( trHead, trCurrent, programStageSelected
							, function()
							{	
								//var eventId = trCurrent.attr( "uid" );	
								// Set this - for complete button show/hide & complete event handler set.
								me.setEventFixedColumn_ForExisting( trCurrent, eventId, eventStatus );
								
								// setTimeout due to the first time Async Data Element retrieval and rendering.
								setTimeout( function() 
								{
									me.getFirstDEControl( trCurrent ).focus();
								}
								, 400);
																
							});

						});

					}
					else
					{
						alert( $( 'span.msg_CheckEventDateStage' ).text() );

						eventDate.focus();
					}
				});

				// Return the reference to the first control, so that it can be focused after the row generate.
				return eventDate;
			}

			this.removeFromStageList = function( eventStage, doneStages )
			{
				if ( doneStages != "" )
				{
					var doneStageArr = doneStages.split(";");

					$.each( doneStageArr, function( i_stage, item_stage )
					{	
						var stageId = Util.trim( item_stage );

						if ( stageId != "" )
						{
							eventStage.find( 'option[value="' + stageId + '"]' ).remove();
						}
					});
				}
			}


			this.getFirstDEControl = function( trCurrent )
			{
				// Set focuse to the first DE element
				return trCurrent.find( "td[colcount='0']" ).find( Util.getStr_Views() ).first();

				//if ( firstDEControl.length > 0 )
			}


			// =========================================================
			// Event Create/Delete Related


			this.eventCreate = function( trCurrent, successFunc )
			{
				//var returnVal = false;

				// check date, program, programstage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				//var eventStatus = trCurrent.find( "span.eventStatus" );

				var eventDel = trCurrent.find( "input.eventDelete" );

				var personUid = trCurrent.closest( '.trPersonDetail' ).attr( 'uid' );
				var orgUnitUid = me.TabularDEObj.getOrgUnitId();

				var eventDateInFormat = Util.formatDate( eventDate.val() );


				// Need to check if the program Stage has (programStages.captureCoordinates 

				var json_Data = {"program": eventProgram.val(), "programStage": eventStage.val(),"orgUnit": orgUnitUid, "eventDate": eventDateInFormat, "coordinate": {}, "status": _status_ACTIVE };
  

				if ( me.TabularDEObj.isCase_SEwoR() )
				{
					me.eventCreate_SubmitData( json_Data, trCurrent, function( eventId, status )
					{
						successFunc( eventId, status );
					});
				}
				else
				{
					json_Data.trackedEntityInstance = personUid;

					// Enrolled
					me.TabularDEObj.programEnroll( personUid, eventProgram.val(), eventDateInFormat
						, function( returnData ) 
						{ 	
							trCurrent.closest( '.trPersonDetail' ).prev().find( '.personInfo' ).click(); 
						}
						, function( returnData ) 
						{
							me.eventCreate_SubmitData( json_Data, trCurrent, function( eventId, status )
							{
								successFunc( eventId, status );
							});							
						}
						, function( returnData ) 
						{ 
							alert( $( 'span.msg_FailedToEnroll' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) ); 
						}
					);
				}
			}


			this.eventCreate_SubmitData = function( json_Data, trCurrent, successFunc )
			{
				RESTUtil.submitData( json_Data, _queryURL_EventSubmit, "POST"
					, function( returnData )
					{
						var importSummary = returnData.importSummaries[0];

						if ( importSummary.status == "SUCCESS" )
						{
							trCurrent.attr( "uid", importSummary.reference );
							
							//me.setEventFixedColumn_ForExisting( trCurrent, importSummary.reference, json_Data.status );

							successFunc( importSummary.reference, json_Data.status );
						}
					}
					, function( returnData ) 
					{
						alert( $( 'span.msg_FailedToCreateEvent' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );
					}
					, function()
					{
						// Loading..
						DialogLoading.open();
					}
					, function()
					{
						// Loading finish..
						DialogLoading.close();
					}
				);
			}


			this.setStatusRelated = function( trCurrent, eventId, programStageId, status )
			{
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				var eventDel = trCurrent.find( "input.eventDelete" );
				var eventRowDel = trCurrent.find( "input.eventRowDelete" );
				var eventComplete = trCurrent.find( "button.eventComplete" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStageDiv = trCurrent.find( "div.eventStageDiv" );

				// Set Status
				eventStatus.html( status );

				if( status == _status_ACTIVE )
				{
					// Delete related
					eventDel.show();

					// remove previous click event
					eventDel.off( 'click' );
					eventRowDel.off( 'click' );

					eventDel.click( function() { me.eventDelete( trCurrent, eventId ); });

					// Complete related
					eventComplete.show();

					eventComplete.click( function() 
					{
						me.eventComplete( trCurrent, eventId, programStageId );
					});
				}
				else if( status == _status_COMPLETED )
				{
					eventDel.hide();
					eventComplete.hide();

					me.TabularDEObj.dataInMemory.retrieveProgramStageData( programStageId, function( json_ProgramStage )
					{
						if ( json_ProgramStage.blockEntryForm )
						{
							// Disable all the DataElements controls - move the control rendering area..
							me.setEventDEControlDisable( trCurrent );
						}
					});
				}


				if ( me.TabularDEObj.getSearchProgramStatus() != _status_ACTIVE )
				{
					eventDel.hide();
					eventComplete.hide();

					me.setEventFixedColumnDisable( trCurrent );
					me.setEventDEControlDisable( trCurrent );					

					Util.paintClear( eventProgramDiv );
					Util.paintClear( eventStageDiv );

					eventProgramDiv.css( 'color', '#80808F' );
					eventStageDiv.css( 'color', '#80808F' );
				}

			}


			this.setEventFixedColumn_ForExisting = function( trCurrent, eventId, status )
			{
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventProgramDiv = trCurrent.find( "div.eventProgramDiv" );
				var eventStageDiv = trCurrent.find( "div.eventStageDiv" );
				var eventRowDelete = trCurrent.find( ".eventRowDelete" );
				var eventCreateTag = trCurrent.find( ".eventCreate" );

				// event date update are place in 'setEventDateSave()'

				// disable the controls
				//Util.disableTag( eventDate, true );
				Util.disableTag( eventCreateTag, true );

				eventProgram.hide();
				eventStage.hide();
				eventCreateTag.hide();

				eventProgramDiv.show().text( eventProgram.find( 'option:selected' ).text() );
				//eventStageDiv.show().html( eventStage.find( 'option:selected' ).text() );
				eventStageDiv.show();

				var selectedStageId = eventStage.attr( "selectedProgramStage" );

				if ( selectedStageId != "" )
				{
					// Simply used to get programStage name.  <-- should do a more efficient way for this..
					me.TabularDEObj.dataInMemory.retrieveProgramStageData( selectedStageId, function( json_ProgramStage )
					{
						eventStageDiv.show().text( json_ProgramStage.name );
					});
				}

				// color the controls
				//Util.paintResult( eventDate, true );
				Util.paintLightGreen( eventProgramDiv );
				Util.paintLightGreen( eventStageDiv );

				// Hide the simple row delete
				eventRowDelete.hide();
				Util.disableTag( eventRowDelete, true );

				// Set status, delete, completed status button related actions.
				me.setStatusRelated( trCurrent, eventId, selectedStageId, status );

			}


			this.eventDelete = function( trCurrent, eventUid )
			{		
				
				if( confirm( $( 'span.msg_ConfirmDelete' ).text() ) )
				{
					// Find the next tabbing tag first.
					var nextTabTag = Util.getNextRowFocus_Event( trCurrent );

					RESTUtil.submitData( undefined, _queryURL_EventSubmit + '/' + eventUid, "DELETE"
						, function()
						{
							alert( $( 'span.msg_EventDeleted' ).text() );
																
							var tableCurrent = trCurrent.closest( 'table' );

							// Remove this row and set focus on next tag
							Util.setRowRemoval( trCurrent, function()
							{							
								// If this is the last row in this table, remove all the DE data columns.
								if ( tableCurrent.find( 'tr.trEventData' ).length == 0 )
								{
									tableCurrent.find( 'tr.trEventHead' ).find( 'th.added' ).remove();
								}
								
								// Set focus to the next tag.
								if ( nextTabTag !== undefined )
								{
									nextTabTag.focus();
								}
							});
							
						}
						, function()
						{							
							alert( $( 'span.msg_EventDeleteFailed' ).text() );

							trCurrent.find( "input.eventDelete" ).focus();
						}
					);
				}
			}


			this.eventComplete = function( trCurrent, eventUid, programStageId )
			{		
				if ( me.checkCompulsoryData( trCurrent ) )
				{
					if( confirm( $( 'span.msg_ConfirmEventComplete' ).text() ) )
					{
						me.eventUpdate( trCurrent, _status_COMPLETED
							, function()
							{
								// Find the next tabbing tag first.
								var nextTabTag = Util.getNextRowFocus_Event( trCurrent );

								// Update the completeted row info/setting..
								me.setStatusRelated( trCurrent, eventUid, programStageId, _status_COMPLETED );

								if ( nextTabTag !== undefined )
								{
									nextTabTag.focus();
								}
							}
						);
					}
				}
			}


			this.addEventRow = function( newRowCount, tableCurrent )
			{
				tableCurrent.append( $( document.createElement( "tr" ) ).attr( 'class', 'trEventData' ).attr( 'uid', '' ).append( me.trTemplate_EventRow ) );

				var lastRow = tableCurrent.find( "tr.trEventData:last" );

				lastRow.attr( me.attr_EventRowNo, newRowCount );


				// Adjust the column count here.
				me.adjustNewRowTDCount( lastRow, tableCurrent );

				// Add delete row event
				lastRow.find( '.eventRowDelete').click( function() 
				{
					var trCurrent = $( this ).closest( 'tr' );

					// Find the next tabbing tag first.
					var nextTabTag = Util.getNextRowFocus_Event( trCurrent );

					Util.setRowRemoval( trCurrent );

					// Set focus to the next tag.
					if ( nextTabTag !== undefined )
					{
						nextTabTag.focus();
					}
				});
				

				// Language translate for realtime created button text.
				me.TabularDEObj.languageSetting.setTranslation_FromSource( tableCurrent.parent(), $( '#translationTagDiv' ) );


				return lastRow;
			}


			this.adjustNewRowTDCount = function( trCurrent, tableCurrent )
			{
				//var columnCount = tableCurrent.find("th.added").length;

				tableCurrent.find( "th.added" ).each( function( index ) {
					
					trCurrent.append( "<td class='added' colCount='" + $( this ).attr("colCount") + "'>&nbsp;</td>");
				} );
			}


			this.adjustRowsTDCount = function( tableCurrent )
			{
				var columnCount = tableCurrent.find("th.added").length;

				tableCurrent.find( "tr.trEventData" ).each( function( i_tr, item_tr ) {

					// For each data row, check if each row has enough td.
					// If not, add them.
					me.addTDRow( $(this), columnCount );

				} );

				//trCurrent.append( "<td colCount='" + $( this ).attr("colCount") + "'>&nbsp;</td>");

			}


			this.addTDRow = function( trCurrent, totalColumnCount )
			{
				var tdCount = trCurrent.find( "td.added" ).length;

				if( tdCount < totalColumnCount )
				{
					for( var i = tdCount; i < totalColumnCount; i++)
					{					
						trCurrent.append( "<td class='added' colCount='" + i + "'>&nbsp;</td>");
					}
				}
			}

			// Event Create/Delete Related
			// =========================================================


			// =========================================================
			// Retrieve and Populate Event Related
			

			this.populateEventsByPersonId = function( personId, trPersonRow, divPersonDetailTag, successFunc )
			{
				var requestUrl = me.getEventsSearchUrl( personId );
				var json_EventList_Sorted = new Array();
				var tbEvents = divPersonDetailTag.find( ".tbStyle_PersonDetail" );

				RESTUtil.getAsynchData( requestUrl, function( json_Events )
				{					
					if ( Util.checkDataExists( json_Events.events ) )
					{
						json_EventList_Sorted = Util.sortByKey( json_Events.events, "eventDate" );

						me.populateEvents( trPersonRow, tbEvents, json_EventList_Sorted );
					}
					else
					{
						// If no event found, create the new event row
						me.addNewLastRow_Event( trPersonRow, tbEvents, me.TabularDEObj.getSelectedProgramId() );
					}

					successFunc( json_EventList_Sorted );
				}
				, function() { successFunc( json_EventList_Sorted ); }
				, function() { FormUtil.setTagAsWait( divPersonDetailTag ); }
				, function() { FormUtil.setTagAsWait_Clear( divPersonDetailTag ); }
				);
			}


			// To be executed by 'Populate' button. - if Program is SEwoR.
			this.retrieveAndPopulateEvents = function( tableCurrent, execFunc )
			{
				// Step 1. Clear the person/event data table
				me.clearEventList();

				var foundNo = 0;

				var requestUrl = me.getEventsSearchUrl();
					
				RESTUtil.getAsynchData( requestUrl, function( json_Events )
				{
					if ( Util.checkDataExists( json_Events.events ) )
					{
						var json_EventList_Sorted = Util.sortByKey( json_Events.events, "eventDate" );

						me.populateEvents( undefined, tableCurrent, json_EventList_Sorted );

						foundNo = json_Events.events.length;
					}


					if ( foundNo == 0 )
					{
						// Create the new event row - simply get basic info
						me.addNewLastRow_Event( undefined, me.mainEventTableTag, me.TabularDEObj.getSelectedProgramId() );
					}

					execFunc( foundNo );
				}
				, function( failed_Message )
				{
					execFunc( foundNo );					

					alert( $( 'span.msg_EventRetrievalFailed' ).text() + '\n\n Error: ' + JSON.stringify( failed_Message ) );

				}
				, DialogLoading.open
				, DialogLoading.close					
				);	
			}


			// =========================================================
			// Populate Event Column Related

			// Move this to populate Layout method section
			this.populateEventColumns = function( trHead, trCurrent, programStageUid, runAfterwards_Func )
			{
				me.TabularDEObj.dataInMemory.retrieveProgramStageData( programStageUid, function( json_ProgramStage )
				{

					trCurrent.find( "td.added" ).html( "" ).attr("DEID", "");

					var count_columnExisting = trHead.find( ".added" ).length;
					//var count_dataElements = json_ProgramStage.programStageDataElements.length;
					var count_current = 0;


					var cssTD_DENameDisplay = "style=''";
					var cssTH_DENameDisplay = "style=''";

					if ( me.TabularDEObj.isCase_SEwoR() )
					{
						cssTD_DENameDisplay = "style='display:none;'";
					}
					else 
					{
						cssTH_DENameDisplay = "style='display:none;'";
					}


					// TODO: place class='before' coordinate at here?
					//		Add class
					if ( Util.checkDefined( json_ProgramStage.captureCoordinates ) && json_ProgramStage.captureCoordinates )
					{
						var coordinateControlTemplate = "<div id='eventCoordinateDiv'><table class='tbNone11'><tr><td>Lat:</td><td><input type='text' class='eventCoorLat' size='7' " + _view + "='" + _view_Y + "'/></td></tr><tr><td>Long:</td><td><input type='text' class='eventCoorLng' size='7' " + _view + "='" + _view_Y + "'/></td></tr></table></div>";

						me.setColumns_AddedPart( count_current++, count_columnExisting, trCurrent, trHead, undefined, "Coordinates", cssTH_DENameDisplay, cssTD_DENameDisplay, coordinateControlTemplate );
					}

					
					// For each data elements, add column.
					$.each( json_ProgramStage.programStageDataElements, function( i, item ) {

						me.setColumns_AddedPart( count_current, count_columnExisting, trCurrent, trHead, item, "", cssTH_DENameDisplay, cssTD_DENameDisplay, _controlsTemplate );

						count_current++;
					});

	
					// After done with data elements, add complete button.
					if ( count_columnExisting > count_current )
					{
						trCurrent.find( "td[colCount='" + count_current + "']" ).append( me.buttonTemplate_Complete );

					}
					else
					{
						trHead.find( 'th[type="completed_button"]' ).attr( 'type', '' );

						trHead.append( me.thTemplate_CompleteButton ).find( 'th[type="completed_button"]' ).attr( 'colcount', count_current );

						trCurrent.append( me.tdTemplate_CompleteButton ).find( 'td[type="completed_button"]' ).attr( 'colcount', count_current );
					}
					


					me.adjustRowsTDCount( trCurrent.closest( ".tbStyle_PersonDetail" ) );


					me.setEventDataSave( trCurrent );


					// This is where the visible attribute is being set ('view=y') and controls are decided.
					me.setEventDEControlTypes( trCurrent );

					
					//me.setCoordinateVisibleAndTabbing( trCurrent, json_ProgramStage.captureCoordinates );


					// Set td background switching event on focus
					Util.setTabBackgroundColor_Switch( trCurrent.find( "input,select,button" ) );
					
					// 
					runAfterwards_Func();

				});

			}

			this.setColumns_AddedPart = function( i, count_columnAdded, trCurrent, trHead, deItem, titleName, cssTH_Name, cssTD_Name, controlsTemplate )
			{
				var deId = "";
				var compulsory = false;
				var compulsorySpan = "";


				if ( Util.checkDefined( deItem ) )
				{
					deId = deItem.dataElement.id;
					compulsory = deItem.compulsory;

					titleName = ( Util.checkValue( deItem.dataElement.formName ) ) ? deItem.dataElement.formName : deItem.dataElement.name;

					if ( deItem.compulsory )
					{
						compulsorySpan = "<span title='Compulsory' class='mandatory'>*</span>";
					}
				}


				// NOTE: Need to count this <-- so we can reuse the exisitng columns
				if( i < count_columnAdded )
				{
					// reuse the column
					trCurrent.find( "td[colCount='" + i + "']" ).attr( "DEID", deId ).attr("compulsory", compulsory ).append( "<span class='dataElementName' " + cssTD_Name + ">" + titleName + compulsorySpan + ": &nbsp;</span>" + controlsTemplate );
				}
				else
				{
					// create the column
					trHead.append( "<th class='added' colCount='" + i + "'><span class='dataElementName' " + cssTH_Name + ">" + titleName + compulsorySpan + "</span>&nbsp;</th>" );

					trCurrent.append( "<td class='added' DEID='" + deId + "' compulsory='" + compulsory + "'  colCount='" + i + "'><span class='dataElementName' " + cssTD_Name + ">" + titleName + compulsorySpan + ": &nbsp;</span>" + controlsTemplate + "</td>" );
				}

			}


			// =========================================================
			// Set Event DataElement Controls

			this.setEventDEControlTypes = function( trCurrent )
			{	

				trCurrent.find( "td.added" ).each( function( index ) 
				{

					var tdTag = $( this ); 
					var DEID = tdTag.attr( "DEID" );


					if( Util.checkValue( DEID ) )
					{					
						// Get dataElement info
						me.TabularDEObj.dataInMemory.retrieveDataElement( DEID, function( json_DataElement )
						{

							if( ( json_DataElement.type == "string" && json_DataElement.optionSet == null ) || json_DataElement.type == "username" )
							{
								tdTag.find( ".textbox" ).show().attr( _view, _view_Y );
							}
							else if ( json_DataElement.type == "int" )
							{
								//<input class='textbox' style='display:none;' type='text' size='15' height='20px' />
								tdTag.find( ".textbox" ).show().attr("size", "5").attr( _view, _view_Y );
							}
							else if( json_DataElement.type == "bool" || ( json_DataElement.type == "string" && json_DataElement.optionSet != null ) )
							{
								var cntrDropdown = tdTag.find( ".dropdown" );

								cntrDropdown.show().attr( _view, _view_Y );

								if( json_DataElement.type == "bool" )
								{
									cntrDropdown.append("<option value='true'>Yes</option>").append("<option value='false'>No</option>");						
								}
								else
								{
									// Get optionSet values
									me.TabularDEObj.dataInMemory.retrieveOptionSets( json_DataElement.optionSet.id, function( json_OptionSets )
									{
										$.each( json_OptionSets.options.sort(), function( i_Option, item_Option) {   
											 cntrDropdown.append( EventUtil.preferredOptionGenerator( item_Option ) );
										});
									});
								}
							}
							else if( json_DataElement.type == "date" )
							{
								Util.setupDatePicker( tdTag.find( ".datepicker" ).show().attr( _view, _view_Y ) );
							}
							else if( json_DataElement.type == "trueOnly" )
							{
								tdTag.find( ".checkbox" ).show().attr( _view, _view_Y );
							}
							else
							{
								alert( "Unknown Column Type Found.  [Name: " + json_DataElement.name + ", ID: " + json_DataElement.id + ", Type: " + json_DataElement.type + "]" );
							}

							// NOTE: HOW THE NUMBER TYPES get affected 'numberType: "number"' on top of the type.

						});
					}
				});
			}

			this.setEventFixedColumnDisable = function( trCurrent )
			{
				// .find( Util.getStr_Views() )
				trCurrent.find( "td.orig" ).find( "input,select" ).each( function( index ) {

					Util.disableTag( $( this ), true );
				});
			}

			this.setEventDEControlDisable = function( trCurrent )
			{
				// .find( Util.getStr_Views() )
				trCurrent.find( "td.added" ).find( "input,select" ).each( function( index ) {

					Util.disableTag( $( this ), true );
				});
			}
			
			
			// Set Event DataElement Controls
			// =========================================================



			// ==============================================
			// Event Save Related

			this.setEventDataSave = function( trCurrent )
			{

				trCurrent.find( "input.eventDate" ).datepicker( "option", "onSelect", function() 
				{
					me.setStatusChecking( $( this ), true );

					me.eventUpdate( trCurrent );
				});

				trCurrent.find( "input.eventCoorLat" ).change( function () {

					me.eventUpdate( trCurrent );
				} );

				trCurrent.find( "input.eventCoorLng" ).change( function () {

					me.eventUpdate( trCurrent );
				} );


				trCurrent.find( "td.added input.textbox" ).change( function () {

					me.eventUpdate( trCurrent );
				} );

				trCurrent.find( "td.added input.datepicker" ).focusout( function () {

					me.eventUpdate( trCurrent );
				} );

				trCurrent.find( "td.added input.checkbox,td.added select" ).change( function () {

					me.eventUpdate( trCurrent );
				} );

				//me.setUp_EntryKeyTabbing( trCurrent.find( "td.added input" ) );
				//me.setUp_OnChangeTabbing( trCurrent.find( "td.added select" ) );
			}


			this.setUp_EntryKeyTabbing = function( tags )
			{
				//if ( $.browser.mozilla ) 
				//{ 
				//	tags.keypress( function( event ) { me.moveNextOnEnter( event, $( this ) ); } ); 
				//} 
				//else 
				//{
					tags.keydown( function( event ) { me.moveNextOnEnter( event, $( this ) ); } );
				//}
			}

			this.setUp_OnChangeTabbing = function( tags )
			{
				tags.change( function( event ) 
				{ 
					//me.moveNextOnEnter( event, $( this ) ); 
					tag = $( this );

					console.log( 'Select Change Detected - ' + tag.val() );

					tag.parent().next().find( Util.getStr_Views() ).first().focus().select();

				} );
			}

			this.moveNextOnEnter = function( event, tag )
			{
				//if ( event.keyCode == 13 )
				if ( event.keyCode == 13 )
				{
					console.log( 'Enter Key Detected - ' + tag.val() );

					var nextTag = tag.parent().next().find( Util.getStr_Views() ).first();
					
					nextTag.focus();

					console.log( 'Next Detected - ' + nextTag.val() );

					nextTag.select();
				}
			}


			this.eventUpdate = function( trCurrent, newStatus, successAction )
			{
				// Assuming that the event was created before, by ProgramStage selection, 
				// when any of the values changes, update the event with all thoes values.
				
				//var trCurrent = itemTag.closest( 'tr' );				

				// check date, program, programstage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				
				var eventCoorLat = trCurrent.find( "input.eventCoorLat" );
				var eventCoorLng = trCurrent.find( "input.eventCoorLng" );

				var personUid = trCurrent.closest( '.trPersonDetail' ).attr( 'uid' );
				var eventUid = trCurrent.attr( 'uid' );

				//var eventLat = trCurrent.attr( 'lat' );
				//var eventLng = trCurrent.attr( 'lng' );

				var eventDateInFormat = Util.formatDate( eventDate.val() );
				
				var status = eventStatus.text();

				if ( Util.checkValue( newStatus ) )
				{
					status = newStatus;
				}
							
				var json_Data = {"program": eventProgram.val(), "programStage": eventStage.val(),"orgUnit": me.TabularDEObj.getOrgUnitId(), "eventDate": eventDateInFormat,  "coordinate": {}, "status": status, "dataValues": me.generateJSON_AllDataColumns( trCurrent ) };

				// if coordinates exists, add them.
				me.setCoordinateData( json_Data.coordinate, eventCoorLat, eventCoorLng );


				if ( !me.TabularDEObj.isCase_SEwoR() )
				{
					json_Data.person = personUid;
				}

				RESTUtil.submitData( json_Data, _queryURL_EventSubmit + '/' + eventUid, "PUT"
					, function()
					{						
						// Clear all coloring
						trCurrent.find( "td.added" ).find( "input,select" ).each( 
							function () 
							{
								Util.paintResult( $(this), false );
							}
						);

						trCurrent.find( "[status='checking']" ).each( 
							function () 
							{
								$(this).attr( "status", "updated" );				 
								Util.paintResult( $(this), true );
							}
						);
						
						if ( successAction !== undefined ) successAction();
					}
					, function()
					{
						alert( $( 'span.msg_EventUpdateFailed' ).text() );
					}
				);
				
			}


			this.checkCompulsoryData = function( trCurrent )
			{
				var pass = true;

				trCurrent.find( "td.added[compulsory='true']" ).find( Util.getStr_Views() ).each( function( index ) 
				{
					var item = $( this );
					
					var dataValue;

					// Check the class and covert the values
					if( item.attr("class") == "datepicker" )
					{
						dataValue = Util.formatDate( item.val() );
					}
					else if( item.attr("class") == "checkbox" )
					{
						dataValue = item.is(":checked") ? "true" : "" ;
					}
					else
					{
						dataValue = item.val();
					}

					if( !Util.checkValue( dataValue ) )
					{	
						Util.paintWarning( item );
						pass = false;
					}
					else
					{
						Util.paintClear( item );
					}
				});

				if ( !pass )
				{
					alert( $( 'span.msg_CompulsoryFill' ).text() );
				}

				return pass;
			}


			this.generateJSON_AllDataColumns = function( trCurrent )
			{

				var dataValues = new Array();

				trCurrent.find("td.added").find( Util.getStr_Views() ).each( function ( i ) 
				{
					var item = $(this);

					var dataElementUID = item.closest("td").attr("DEID");
					var dataValue;
		
					if ( Util.checkValue( dataElementUID ) )
					{
						// Check the class and covert the values
						if( item.attr("class") == "datepicker" )
						{
							dataValue = Util.formatDate( item.val() );
						}
						else if( item.attr("class") == "checkbox" )
						{
							dataValue = item.is(":checked") ? "true" : "" ;
						}
						else
						{
							dataValue = item.val();
						}


						if( Util.checkValue( dataValue ) )
						{
							var dataElementJSON = { "dataElement": dataElementUID, "value": dataValue };
						
							dataValues.push(dataElementJSON);

							me.setStatusChecking( item, true );
						}
						else
						{
							me.setStatusChecking( item, false );
						}
					}

				});

				return dataValues;
			}


			this.setStatusChecking = function( tag, isChecking )
			{
				var checkingStr = ( isChecking ) ? "checking" : "";

				tag.attr( "status", checkingStr );
			}


			this.setCoordinateData = function( coordinate, eventCoorLatTag, eventCoorLngTag )
			{
				me.setStatusChecking( eventCoorLatTag, false );
				me.setStatusChecking( eventCoorLngTag, false );
				
				if ( Util.checkValue( eventCoorLatTag.val() ) ) 
				{
					coordinate.latitude = eventCoorLatTag.val();
					me.setStatusChecking( eventCoorLatTag, true );
				}

				if ( Util.checkValue( eventCoorLngTag.val() ) ) 
				{
					coordinate.longitude = eventCoorLngTag.val();
					me.setStatusChecking( eventCoorLngTag, true );
				}
			}


			// Event Search from default setting - populate
			this.getEventsDefaultPopulate_SearchUrl = function()
			{				
				var orgUnitId = me.TabularDEObj.getOrgUnitId();
				var programId = me.TabularDEObj.getSelectedProgramId();
				var startDate = me.TabularDEObj.getDefaultStartDate();
				var endDate = me.TabularDEObj.getDefaultEndDate();
				
				var searchAllProgramStr = "";

				if ( !me.TabularDEObj.searchPanel.searchAllProgramTag.is( ":checked" ) && Util.checkValue( programId ) )
				{
					searchAllProgramStr = '&program=' + programId;
				}

				return me.TabularDEObj.getEventQueryBaseUrl() 
				+ '&orgUnit=' + orgUnitId 
				+ '&startDate=' + $.format.date( startDate, _dateFormat_YYYYMMDD_Dash ) 
				+ '&endDate=' + $.format.date( endDate, _dateFormat_YYYYMMDD_Dash ) 
				+ searchAllProgramStr; 
			}


			this.getEventsSearchUrl = function( personId )
			{
				var returnUrl = "";

				// If list All perosn historical events flag is set, remove the date/program/orgUnit filter.
				if ( me.TabularDEObj.searchPanel.listAllPersonHistoricalEventsTag.is( ":checked" ) && me.TabularDEObj.isCase_MEwR() )
				{
					returnUrl = me.TabularDEObj.getEventQueryBaseUrl();
				}
				else
				{
					returnUrl = me.getEventsDefaultPopulate_SearchUrl();
				}

				if ( Util.checkValue( personId ) )
				{
					returnUrl += '&trackedEntityInstance=' + personId;
				}

				return returnUrl;
			}


			// -------------------------------------
			// -- Populate Events Related ----------

			this.populateEvents = function( trPerson, item_EventTable, json_Events )
			{
				//var orgUnitUid = me.TabularDEObj.getOrgUnitId();
				item_EventTable.find( "tr.trEventData" ).remove();
				item_EventTable.find( "tr.trEventHead th.added" ).remove();

				if( Util.checkDataExists( json_Events ) )
				{
					$.each( json_Events, function( i_event, item_event ) 
					{
						// Create the new event row - simply get basic info
						me.addNewLastRow_Event( trPerson, item_EventTable, item_event.program );

						// Populate Event Columns and Data.
						me.populateEventData( item_EventTable, item_event );

					});
				}
			}

			this.populateEventData = function( tableCurrent, item_event )
			{
				var trHead = tableCurrent.find( "tr.trEventHead:first" );
				var trCurrent = tableCurrent.find( "tr.trEventData:last" );


				// -----------------------------------------------
				// --- STEP 1. Populate first 3 row - Event date, program, stage
				var eventDate = trCurrent.find( "input.eventDate" );
				var eventOrgUnit = trCurrent.find( "span.eventOrgUnit" );
				var eventProgram = trCurrent.find( "select.eventProgram" );
				var eventStage = trCurrent.find( "select.eventStage" );
				var eventStatus = trCurrent.find( "span.eventStatus" );
				var eventDel = trCurrent.find( "input.eventDelete" );

				eventDate.val( Util.formatDateBack( item_event.eventDate ) );
				
				// Select Program/ProgramStages <-- if not in select option, add one.
				Util.selectOption_WithOptionalInsert( eventProgram, item_event.program, me.TabularDEObj.getProgramList_Full() );
				
				Util.selectOption_WithOptionalInsert( eventStage, item_event.programStage, me.TabularDEObj.getProgramStageList_Full() );
				//eventProgram.val( item_event.program );
				//eventStage.val( item_event.programStage );

				eventStage.attr( "selectedProgramStage", item_event.programStage ); 

				// Disable 3 rows
				// put event id
				trCurrent.attr( "uid", item_event.event );	
				

				// Set Event Org Unit Name - only for MEwR case.
				if ( !me.TabularDEObj.isCase_SEwoR() )
				{
					me.TabularDEObj.dataInMemory.retrieveOrgUnitName( item_event.orgUnit, function( json_OrgUnit ) 
					{
						eventOrgUnit.text( json_OrgUnit.name );
					});
				}


				// -----------------------------------------------
				// --- STEP 2. Render the program stage selected data element controls


				// 3. Populate the data element columns
				
				//me.populateEventColumns( trHead, trCurrent, eventStage.val(), function() 
				me.populateEventColumns( trHead, trCurrent, item_event.programStage, function() 
				{ 
					// Put coordinate values to input tags
					me.populateCoordinateTagData( item_event.coordinate, trCurrent.find( "input.eventCoorLat" ), trCurrent.find( "input.eventCoorLng" ) );

					// Populate data element values
					if( item_event.dataValues !== undefined )
					{
						// Populate Data Values
						$.each( item_event.dataValues, function( i_dataValue, item_dataValue ) {

							if( item_dataValue.dataElement !== undefined )
							{

								var tdItem = trCurrent.find( "td[DEID='" + item_dataValue.dataElement + "']" );

								if( tdItem !== undefined )
								{

									tdItem.find( Util.getStr_Views() ).each( function ( i_controls )
									{
										var item = $( this );

										// Check the class and covert the values
										if( item.attr("class") == "datepicker" )
										{
											item.val( Util.formatDateBack( item_dataValue.value ) );
										}
										else if( item.attr("class") == "checkbox" )
										{
											// TODO: Make sure this works!!
											item.prop('checked', item_dataValue.value );
										}
										else
										{
											item.val( item_dataValue.value );
										}

									});
								}
							}
						});

					}

					// Set this 
					me.setEventFixedColumn_ForExisting( trCurrent, item_event.event, item_event.status );
				});

			}


			this.populateCoordinateTagData = function( coordinate, latTag, lngTag )
			{
				if ( coordinate !== undefined )
				{
					if ( coordinate.latitude !== undefined ) latTag.val( coordinate.latitude );
					if ( coordinate.longitude !== undefined ) lngTag.val( coordinate.longitude );
				}
			}

			// -- Populate Events Related ----------
			// -------------------------------------


			this.retreivePersonListWithEvents = function( returnFunc )
			{
				var personEventList = new Array();

				var requestUrl = me.getEventsDefaultPopulate_SearchUrl();


				// Step 1. Get the search criteria Events
				RESTUtil.getAsynchData( requestUrl, function( json_Events ) 
				{
					// Sort the personInfo here.
					if ( json_Events.events !== undefined )
					{
						var eventList_Sorted = Util.sortByKey( json_Events.events, "eventDate" );

						// Use this personLis to group the events under?
						personEventList = me.createPersonEventList( eventList_Sorted );
					}						

					// Empty personObjList_Sorted..
					returnFunc( personEventList );

				}
				, function() 
				{
					console.log( 'Failed to query events' );
					returnFunc( personEventList );
				} 
				, DialogLoading.open
				, DialogLoading.close				
				);

			}



			this.createPersonEventList = function( events )
			{
				var personList = new Array();

				$.each( events, function( i_event, item_event ) 
				{
					if ( Util.checkValue( item_event.trackedEntityInstance ) )
					{
						var personObj = me.getPersonObject( personList, item_event.trackedEntityInstance );
						
						// Add events into the personObj
						if ( personObj.events === undefined )
						{
							personObj.events = new Array();
						}
						
						personObj.events.push( item_event );
					}
				});
		
				return personList;
			}


			this.getPersonObject = function( personList, personId )
			{
				var personObj = Util.getFromList( personList, personId, 'trackedEntityInstance' );

				if ( personObj === undefined )
				{
					personList.push( { 'trackedEntityInstance': personId } );

					personObj = Util.getFromList( personList, personId, 'trackedEntityInstance' );
				}

				return personObj;
			}


			// Obsolete!!!!
			/*
			this.addEventsToPerson = function( personObjList, events )
			{
				$.each( events, function( i_event, item_event ) 
				{
					// Get person Obj by person ID
					var personObj = Util.getFromList( personObjList, item_event.trackedEntityInstance, "trackedEntityInstance" );

					if ( personObj !== undefined )
					{

						if ( personObj.events === undefined )
						{
							personObj.events = new Array();
						}

						//Util.write( 'personObj: ' + JSON.stringify( personObj ) );
						//personObj.events.personEventList
						personObj.events.push( item_event );
					}
				});
			}
			*/
		}

		// PersonEvent Class
		// -------------------------------------------


		// ============================================================================
		// ============================================================================

		// -------------------------------------------
		// Class - Data In Memory
		//			- Data In Memory holding class
		function DataInMemory()
		{
			var me = this;

			this.orgUnitNameList = new Array();

			this.programStageDataElements = new Array();
			this.dataElementList = new Array();
			this.dataElementOptionSets = new Array();

			this.programList_Full = new Array();
			this.programStageList_Full = new Array();
			this.programListWithStage_Full;


			// --------------------------
			// Run methods


			// ---------------------------------------
			// --- Each data retrieval method

			this.retrieveOptionSets = function( optionSetId, runFunc )
			{
				me.retrieveFromMemory( me.dataElementOptionSets, 'id', optionSetId, _queryURL_OptionSets + optionSetId + '.json', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			this.retrieveDataElement = function( dataElementId, runFunc )
			{
				me.retrieveFromMemory( me.dataElementList, 'id', dataElementId, _queryURL_DataElementDetail + dataElementId + '.json', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			this.retrieveProgramStageData = function( programStageId, runFunc )
			{
				me.retrieveFromMemory( me.programStageDataElements, 'id', programStageId, _queryURL_ProgramStages + '/' + programStageId + '.json?fields=id,name,displayName,description,repeatable,captureCoordinates,program[id,name],programStageDataElements[compulsory,sortOrder,allowFutureDate,dataElement[id,name,formName]]', function( dataObj )
				{
					if ( runFunc !== undefined )
					{
						runFunc( dataObj );
					}
				});
			}


			this.retrieveOrgUnitName = function( orgUnitId, runFunc )
			{
				me.retrieveFromMemory( me.orgUnitNameList, 'id', orgUnitId, _queryURL_OrgUnit + '/' + orgUnitId + '.json?fields=id,name', function( dataObj )
				{
					runFunc( dataObj );
				});
			}


			this.retrieveProgramStageList = function( runFunc )
			{
				me.retrieveFromMemory( me.programStageList_Full, 'id', 'programStageFull', _queryURL_ProgramStages + '.json?paging=false&fields=id,name,displayName,description,repeatable,captureCoordinates,program[id,name],programStageDataElements[compulsory,sortOrder,allowFutureDate,dataElement[id,name,formName]]'
					, function( json_programStageList )
					{
						if ( runFunc !== undefined )
						{
							runFunc( json_programStageList );
						}
					}
				);
			}


			this.retrieveProgramListWithStage_Full = function( runFunc )
			{
				if ( me.programListWithStage_Full !== undefined )
				{
					runFunc( me.programListWithStage_Full );
				}
				else
				{
					me.retrieveFromMemory( me.programList_Full, 'id', 'programFull', _queryURL_ProgramList + '?paging=false&fields=id,name,type,onlyEnrollOnce,trackedEntity'
						, function( json_programList )
						{	
							me.retrieveProgramStageList( function( json_programStageList )
								{
									me.programListWithStage_Full = me.setProgramWithStage( json_programList.programs, json_programStageList.programStages );

									runFunc( me.programListWithStage_Full );
								}
							);

						}
					);
				}
			}


			// --- Each data retrieval method
			// ---------------------------------------

			// Retrieve from API or from memory if already retrieved.
			// This use queueing in case the data is already being in process of retrieving, but not yet finished.  We could use event call for each..
			this.retrieveFromMemory = function( dataList, idName, idValue, requestUrl, runFunc )
			{

				var json_Data = Util.getFromList( dataList, idValue, idName );

				if ( json_Data === undefined )
				{
					// For the first time requesting, create a queue and run Async..

					var dataNew = {};
					
					dataNew[ idName ] = idValue;
					dataNew.data = null;
					dataNew.requestQueue = new Array();
					dataNew.requestQueue.push( runFunc );

					dataList.push( dataNew );


					// Retrieve it
					RESTUtil.getAsynchData( requestUrl, function( dataObj ) 
					{
						// Once it gets data, run all the return functions..
						json_Data = Util.getFromList( dataList, idValue, idName );

						if ( Util.checkDefined( json_Data ) )
						{
							json_Data.data = dataObj;

							$.each( json_Data.requestQueue, function( i_func, item_func )
							{
								item_func( dataObj );
							});

							// reset the queue.
							json_Data.requestQueue = new Array();
						}
						else
						{
							Util.write( 'RESTUtil.getAsynchData FOR MEMORY get undefined value back! - idName:' + idName + ', idValue:' + idValue + ', dataList:' + JSON.stringify( dataList ) );
						}

					});
				}
				else
				{
					if ( Util.checkDefined( json_Data.data ) )
					{
						runFunc( json_Data.data );

						// ?? run any queue function if still here?
					}
					else
					{
						// Add return fucntions to the queue.
						json_Data.requestQueue.push( runFunc );
					}
				}
			}


			this.insertDirectToMemory = function( dataList, idName, idValue, data )
			{
				var dataNew = {};
				
				dataNew[ idName ] = idValue;
				dataNew.data = data;
				dataNew.requestQueue = new Array();

				dataList.push( dataNew );
			}

			// -------------------
			// -- Helper methods

			this.setProgramWithStage = function( programs, programStages )
			{
				for( j = 0; j < programStages.length; j++ )
				{
					var item_stage = programStages[j];

					if ( item_stage.program !== undefined )
					{

						for( i = 0; i < programs.length; i++ )
						{
							if ( programs[i].id == item_stage.program.id )
							{
								var programMatch = programs[i];

								if ( programMatch.programStages === undefined )
								{
									programMatch.programStages = [];
								}

								programMatch.programStages.push( item_stage );

								break;
							}
						}
					}
				}

				return programs;
			}

			// -- Helper methods
			// -------------------

			// Run methods
			// --------------------------


			// --------------------------
			// Get methods

			this.getProgramList_Full = function()
			{
				return me.programListWithStage_Full; // pme.programList_Full[0].data;
			}

			this.getProgramStageList_Full = function()
			{
				return me.programStageList_Full[0].data;
			}

			// Get methods
			// --------------------------
		}

		// Data In Memory Class
		// -------------------------------------------


		// ============================================================================
		// ============================================================================


		// -------------------------------------------
		// Class - PersonDialogForm
		//		- Used for popup Person Add/Edit Form

		function PersonDialogForm( TabularDEObj )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.type_New = "New";
			this.type_Exist = "Exist";

			this.personDialogFormTag = $( "#personDialogForm" );

			this.personDialogTableTag = this.personDialogFormTag.find( "#person_Table" );

			this.currentPersonTr;

			this.json_PersonAttributes;

			this.trackedEntityId_Person;


			// -------------------------------------------
			// Methods

			this.openForm = function( currentTr )
			{
				me.currentPersonTr = currentTr;

				me.personDialogFormTag.dialog( "open" );
			}


			this.getTrackedEntityId_Person = function()
			{
				if ( me.trackedEntityId_Person === undefined )
				{
					var json_TrackedEntities = $.parseJSON( RESTUtil.getSynchData( _queryURL_TrackedEntities + '.json?query=Person' ) );

					for ( i = 0; i < json_TrackedEntities.trackedEntities.length ; i++ )
					{
						var trackedEntity = json_TrackedEntities.trackedEntities[i];

						if ( trackedEntity.name == "Person" )
						{
							me.trackedEntityId_Person = trackedEntity.id;
							break;
						}
					}
				}

				if ( me.trackedEntityId_Person === undefined )
				{
					alert( $( 'span.msg_PersonNotFoundDHIS' ).text() );
				}

				return me.trackedEntityId_Person;
			}

			this.getPersonAttributeById = function( attributeId )
			{
				var personAttribute;


				if ( Util.checkValue( attributeId ) )
				{
					// If person Attribute does not exists, retrieve it.
					if ( me.json_PersonAttributes === undefined )
					{
						me.json_PersonAttributes = $.parseJSON( RESTUtil.getSynchData( _queryURL_PersonAttributes ) );
					}

					if ( me.json_PersonAttributes !== undefined )
					{
						for ( i = 0; i < me.json_PersonAttributes.trackedEntityAttributes.length ; i++ )
						{
							if ( me.json_PersonAttributes.trackedEntityAttributes[i].id == attributeId )
							{
								personAttribute = me.json_PersonAttributes.trackedEntityAttributes[i];
								break;
							}
						}
					}
				}

				return personAttribute;
			}
			

			this.SetRowControls_Attribute = function( attributeId, mandatory, value, existingData )
			{
				var trCurrent;

				if ( existingData )
				{
					me.personDialogTableTag.find( "td[attributeid='" + attributeId + "']" ).each( function( index ) 
					{
						trCurrent = $( this ).closest( "tr" );
					});
				}


				// Step 1. Retrieve person attribute properties and display at here.
				var personAttribute = me.getPersonAttributeById( attributeId );
				

				if ( trCurrent === undefined )
				{
					if ( Util.checkDefined( personAttribute ) )
					{
						// Render the control and set value if availble
						var visibleInfo = "";

						// If this is from person, not from program, hide visibly, so that, for saveing/updating, it gets added. <-- even though it is not part of program info.
						if ( existingData )
						{
							visibleInfo = "style='display:none;'";
						}

						var mandatorySpan = "";
						var mandatoryAttribute = "";

						if ( mandatory )
						{
							mandatorySpan = "<span title='Mandatory' class='mandatory'>*</span>";
							mandatoryAttribute = "mandatory='true'";
						}

						// Step 2. Add template row to the table <-- via append
						me.personDialogTableTag.append("<tr " + visibleInfo + "><td><span class='attrname'>" + personAttribute.name + "</span>" + mandatorySpan + "</td><td type='attribute' " + mandatoryAttribute + " attributeId='" + attributeId + "'>" + _controlsTemplate + "</td></tr>");

						// Step 3. Show the proper control for the data type + value.
						var trCurrent = me.personDialogTableTag.find( "tr:last" );
	
						//me.getPersonAttributeOptionSets( personAttribute, function()
						//{
							var controlTag = me.setAttributeControlType( trCurrent, personAttribute.valueType, personAttribute.optionSet, value );

							controlTag.show();
						//});
					}
					else
					{
						Util.write( 'Person Attributes not found - id:', attributeId );
					}

				}
				else
				{
					me.setAttributeControlType( trCurrent, personAttribute.valueType, null, value );
				}
			}


			this.setAttributeControlType = function( trCurrent, type, optionSet, value )
			{	
				var attributeControl;

				if ( !Util.checkDefined( value ) ) value = '';

				if( type == "string" || type == "phoneNumber" || type == "users" )
				{
					// TODO: For now, have 'username' display as textbox <-- should be user listing

					attributeControl = trCurrent.find( ".textbox" ).val( value ).attr( _view, _view_Y );
				}
				else if ( type == "number" || type == "age" )
				{
					attributeControl = trCurrent.find( ".textbox" ).val( value ).attr("size", "5").attr( _view, _view_Y );
				}
				else if( type == "combo" || type == "optionSet" )
				{
					var cntrDropdown = trCurrent.find( ".dropdown" );

					attributeControl = cntrDropdown.attr( _view, _view_Y );

					if ( Util.checkDefined( optionSet ) )
					{
						cntrDropdown.empty();
						cntrDropdown.append("<option value=''>Select Value</option>");

						if ( optionSet.options !== undefined )
						{
							$.each( optionSet.options, function( i_Option, item_Option) {   
								 cntrDropdown.append("<option>" + item_Option + "</option>");
							});
						}
					}
					
					Util.selectOption_WithOptionalInsert( cntrDropdown, value );

				}
				else if( type == "date" )
				{
					attributeControl = trCurrent.find( ".datepicker" ).val( value ).attr( _view, _view_Y );

					// If it is birth date, set attribute for that, so that start/end year can be set appropriately.
					if ( Util.stringSearch( trCurrent.find( 'span.attrname' ).text(), "birth" ) )
					{
						attributeControl.attr( 'caltype', 'birth' );
					}
					else
					{
						attributeControl.attr( 'caltype', 'none' );
					}
				}
				else if( type == "bool" )
				{
					var cntrDropdown = trCurrent.find( ".dropdown" );

					attributeControl= cntrDropdown.attr( _view, _view_Y );


					if ( !Util.checkDefined( personAttributeOptions ) )
					{
						cntrDropdown.empty();
					
						Util.setSelectTagOptions_YesNo( cntrDropdown );
					}

					// TODO: MIGHT NEED TO CONVERT VALUES BETWEEN 'true'/'false' & 'Yes'/'No'
					cntrDropdown.val( value );
				}
				else if( type == "trueOnly" || type == "trackerAssociate" )
				{
					// TODO: NEED to check this - probably need to convert string to boolean
					attributeControl = trCurrent.find( ".checkbox" ).val( value ).attr( _view, _view_Y );
				}
				else
				{
					attributeControl = trCurrent.find( ".label" ).html( 'Unknown Type: ' + type ).attr( _view, _view_Y );
					//Util.write( "Person Attribute - Unknown Type: " + type );
				}

				return attributeControl;
			}
			
			
			this.RenderPersonElements = function( programTrackedEntityAttributes, setRowControlsFunc, existingData )
			{
				
				if ( programTrackedEntityAttributes !== undefined )
				{
					$.each( programTrackedEntityAttributes, function( i_element, item_element ) 
					{
						if ( Util.checkDefined( existingData ) )
						{
							var elementValue = Util.getFormattedAttributeValue( item_element );

							setRowControlsFunc( item_element.id, item_element.mandatory, elementValue, true );
						}
						else
						{
							setRowControlsFunc( item_element.id, item_element.mandatory );
						}
					});
				}
			}


			this.setupPersonData = function( orgUnitId )
			{
				var newPersonObj = {};

				newPersonObj[ "orgUnit" ] = orgUnitId;

				newPersonObj[ "trackedEntity" ] = me.getTrackedEntityId_Person();

				newPersonObj[ "attributes" ] = me.constructAttributes();

				return newPersonObj;
			}

			this.checkMandatoryData = function()
			{
				var pass = true;

				me.personDialogTableTag.find( "td[type='attribute'][mandatory='true']" ).find( Util.getStr_Views() ).each( function( index ) 
				{

					var item = $( this );
					
					//var attributeId = item.closest( "td" ).attr( "attributeId" );

					var dataValue;
		
					// Check the class and covert the values
					if( item.attr( "class" ) == "datepicker" )
					{
						dataValue = Util.formatDate( item.val() );
					}
					else if( item.attr( "class" ) == "checkbox" )
					{
						dataValue = item.is( ":checked" ) ? "true" : "" ;
					}
					else
					{
						dataValue = item.val();
					}

					if( !Util.checkValue( dataValue ) )
					{	
						Util.paintWarning( item );
						pass = false;
					}
					else
					{
						Util.paintClear( item );
					}

				});

				if ( !pass )
				{
					alert( $( 'span.msg_MandatoryFill' ).text() );
				}

				return pass;
			}


			this.checkDuplicateData = function( orgUnitId, defaultProgramId, personId, runFunc )
			{
				// Prepare the data
				var paramData = 'orgUnitId=' + orgUnitId + '&programId=' + defaultProgramId;

				if ( personId !== undefined ) paramData += '&uid=' + personId;

				var attributes = me.constructAttributes();

				$.each( attributes, function( i, item )
				{
					paramData += '&attr' + item.attribute + '=' + item.value;
				});

				$.ajax({
					type: "POST"
					,url: _queryURL_PersonDataValidate
					,data: paramData
					,datatype: "json"
					,async: true
					,success: function( returnData )
					{
						if ( returnData.response == 'success' && returnData.message == "" )
						{
							runFunc();
						}
						else
						{
							alert( 'Failed.  Reason: ' + returnData.message );
						}
					}
				});
			}


			this.constructAttributes = function()
			{
				var attributes = new Array();

				me.personDialogTableTag.find( "td[type='attribute']" ).find( Util.getStr_Views() ).each( function( index ) 
				{
					//Util.write( "In each list.. " );

					var item = $( this );
					
					var attributeId = item.closest( "td" ).attr( "attributeId" );

					var dataValue;
		
					// Check the class and covert the values
					if( item.attr( "class" ) == "datepicker" )
					{
						dataValue = Util.formatDate( item.val() );
					}
					else if( item.attr( "class" ) == "checkbox" )
					{
						dataValue = item.is( ":checked" ) ? "true" : "" ;
					}
					else
					{
						dataValue = item.val();
					}

					if( Util.checkValue( dataValue ) )
					{					
						attributes.push( { "attribute": attributeId, "value": dataValue } );
					}
				});

				return attributes;
			}


			this.setupForm = function( trCurrent, type )
			{
				var setupStatus = false;
				var orgUnitId = me.TabularDEObj.getOrgUnitId();
				var defaultProgramId = me.TabularDEObj.getSelectedProgramId();


				if ( !Util.checkValue( defaultProgramId ) )
				{
					alert( $( 'span.msg_SelectDefaultProgram' ).text() );
				}
				else
				{

					// Clear Table
					me.personDialogTableTag.find( "tr" ).remove();


					var button_Create = $( ".ui-dialog-buttonpane button:contains('Create')" ).button();
					var button_Update = $( ".ui-dialog-buttonpane button:contains('Update')" ).button();

					button_Create.hide();
					button_Update.hide();


					me.personDialogFormTag.find( "#person_formType" ).val( type );
					

					// Render Attributes
					// Step 2. Add template row to the table <-- via append
					var programTrackedEntityAttributes = me.TabularDEObj.getProgramTrackedEntityAttributes();

					
					me.personDialogTableTag.append("<tr><td colspan='2' style='font-weight:bold;'>Attributes</td></tr>");
					me.RenderPersonElements( programTrackedEntityAttributes, me.SetRowControls_Attribute );


					// Depending on 'New' or 'Existing' person data, populate the existing data.
					if( type == me.type_New ) 
					{
						// Load the suggested value
						var person_SuggestedTd = trCurrent.find( "td[type='attribute_0']" );
						var person_SuggestedVal = person_SuggestedTd.find( ".personSelect" ).val();
						var person_SuggestedAttrbuiteId = person_SuggestedTd.attr( 'attributeid' );

						me.SetRowControls_Attribute( person_SuggestedAttrbuiteId, false, person_SuggestedVal, true );

						button_Create.show();
					}					
					else if ( type == me.type_Exist )
					{

						button_Update.show();
						

						var personID = trCurrent.attr( 'uid' );
						me.personDialogFormTag.find( "#person_id" ).val( personID );

						var item_Person = PersonUtil.getPersonByID( personID );

						// For person attributes, add value, and if not in program, hide them.
						PersonUtil.addIDtypeToID( item_Person );
						
						
						//Util.write( " ID create: " + JSON.stringify( item_Person ) );

						if ( Util.checkDefined( item_Person ) )
						{
							// This also renders non-program specific attributes as hidden.
							me.RenderPersonElements( item_Person.attributes, me.SetRowControls_Attribute, true );
						}
						else
						{
							alert( $( 'span.msg_PersonNotFound' ).text() );
						}
										
						// View Only
						//Util.disableTag( me.personDialogFormTag.find( "#person_Table" ).find( "input,select" ), true )

					}
						

					Util.setupDatePicker( me.personDialogTableTag.find( ".datepicker[caltype='none']" ), undefined, _dateFormat_Picker_YYMMDD_Dash );

					Util.setupDatePicker( me.personDialogTableTag.find( ".datepicker[caltype='birth']" ), undefined, _dateFormat_Picker_YYMMDD_Dash, "birthdate" );

					setupStatus = true;
				}

				return setupStatus;
			}


			this.FormPopupSetup = function()
			{

				// -- Set up the form -------------------
				me.personDialogFormTag.dialog({
				  autoOpen: false,
				  dialogClass: "noTitleStuff",
				  width: 355,
				  height: 350,
				  modal: true,
				  buttons: {
					"Create": function() {

						var dialogForm = $( this );

						// Perform the mandatory filled check first.
						if ( me.checkMandatoryData() )
						{
							var orgUnitId = me.TabularDEObj.getOrgUnitId();
							var defaultProgramId = me.TabularDEObj.getSelectedProgramId();
							var defaultDateInFormat = $.format.date( me.TabularDEObj.getDefaultStartDate(), _dateFormat_YYYYMMDD_Dash );

							me.checkDuplicateData( orgUnitId, defaultProgramId, undefined, function()
							{
								var personData  = me.setupPersonData( orgUnitId );

								RESTUtil.submitData( personData, _queryURL_PersonSubmit, "POST"
									, function( returnData )
									{
										if ( returnData.status != 'SUCCESS' )
										{
											me.personCreateUpdate_Fail_Handle( returnData );
										}
										else
										{																						
											var personId = returnData.reference;

											if ( Util.checkDefined( personId ) )
											{
												alert( $( 'span.msg_PersonCreated' ).text() );

												// Enroll
												me.TabularDEObj.programEnroll( personId, defaultProgramId, defaultDateInFormat
													, function( returnData ) 
													{
														alert( $( 'span.msg_ProgramEnrolled' ).text() );
													}
													, function() {}
													, function( returnData ) { alert( $( 'span.msg_ProgramEnrollFailed' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) ); }
												);
												

												//var item_Person = PersonUtil.getPersonByID( personId );
												
												PersonUtil.getPersonByID_Async( personId, function( item_Person )
												{
													me.TabularDEObj.setPersonInfoRow( me.currentPersonTr, item_Person );

													// Auto Close after Create New
													dialogForm.dialog( "close" );
													me.currentPersonTr.find( '.personInfo' ).focus();
												});
											}
										}
									}
									, me.personCreateUpdate_Fail_Handle
								);
							});
						}

					},
					"Update": function() {

						var dialogForm = $( this );

						// Perform the mandatory filled check first.
						if ( me.checkMandatoryData() )
						{
							var orgUnitId = me.TabularDEObj.getOrgUnitId();
							var defaultProgramId = me.TabularDEObj.getSelectedProgramId();
							var defaultDateInFormat = $.format.date( me.TabularDEObj.getDefaultStartDate(), _dateFormat_YYYYMMDD_Dash );

							var personId = me.personDialogFormTag.find( "#person_id" ).val();

							me.checkDuplicateData( orgUnitId, defaultProgramId, personId, function()
							{

								var personData  = me.setupPersonData( orgUnitId );

								RESTUtil.submitData( personData, _queryURL_PersonSubmit + '/' + personId, "PUT"
									, function( returnData )
									{

										if ( returnData.status != 'SUCCESS' )
										{
											me.personCreateUpdate_Fail_Handle( returnData );
										}
										else
										{

											alert( $( 'span.msg_PersonInfoUpdated' ).text() );
											
											me.TabularDEObj.programEnroll( personId, defaultProgramId, defaultDateInFormat
												, function( returnData ) 
												{
													alert( $( 'span.msg_ProgramEnrolled' ).text() );
												}
												, function() {}
												, function( returnData ) 
												{ 
													alert( $( 'span.msg_ProgramEnrollFailed' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) ); 
												}
											);

											//var item_Person = PersonUtil.getPersonByID( personId );
											
											PersonUtil.getPersonByID_Async( personId, function( item_Person )
											{
												me.TabularDEObj.populatePersonAttirbutesToRow( me.currentPersonTr, item_Person.attributes );

												// Auto Close after Update
												dialogForm.dialog( "close" );
												me.currentPersonTr.find( '.personInfo' ).focus();
											});
										}

									}
									, me.personCreateUpdate_Fail_Handle
								);
							});
						}

					},
					"Close": function() {
						$( this ).dialog( "close" );

						me.currentPersonTr.find( '.personInfo' ).focus();
					}
				  }
				});		
			}

			this.personCreateUpdate_Fail_Handle = function( returnData )
			{
				$( "#person_Result" ).val( "Fail" );

				alert( $( 'span.msg_PersonCreateUpdateFailed' ).text() + '\n\n Error: ' + JSON.stringify( returnData ) );

				me.personDialogFormTag.find( 'button' ).filter( ':visible' ).first().focus();
			}


			// Initial Setup Call
			this.initialSetup = function()
			{				
				me.FormPopupSetup();
			}


			// Initial Setup Call
			this.initialSetup();

		}

		// PersonDialogForm Class
		// -------------------------------------------


		// -------------------------------------------
		// Class - LanguageSetting
		//		- Used for popup Person Add/Edit Form

		function LanguageSetting( TabularDEObj )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.dbSettingName = "App_TabularData_Lang_";

			this.dialogFormTag = $( "#languageDialogForm" );

			this.languageSelectTag = $( '#language' );

			this.languageEditTag = $( '#languageEdit' );

			this.languageTableTag = $( '#language_Table' );
			
			//this.translationAddNewRowTag = $( '#translation_addNewRow' );

			this.translationNames = [];
			// Add in 'translationNames' that does not get catched in the beginning, but shows up during operation.

			this.languageRememberName = "languageRemember";
			//this.personDialogTableTag = this.personDialogFormTag.find( "#person_Table" );

			// -------------------------------------------
			// Methods

			this.getLanuageDBSettingName = function()
			{
				return me.dbSettingName + me.languageSelectTag.val();
			}


			this.setTranslationNameSets = function()
			{
				//me.translationNames = new Array();

				$( "span[nameId]" ).each( function()
				{
					var nameId = $( this ).attr( 'nameId' );
					var nameText = $( this ).text();

					if ( !Util.checkExistInList( me.translationNames, nameId, 'id' ) )
					{
						me.translationNames.push( { id: nameId, value: nameText } );
					}
				});
			}


			this.setupForm = function()
			{
				// Load the language json from setting
				// and populate the table
				if ( me.languageSelectTag.val() != "" )
				{
					me.getTranslationJSON( function( jsonTranslation )
					{

						// Populate the table..
						
						// Add header to the table
						me.languageTableTag.find( "tr" ).remove();

						me.languageTableTag.append( "<tr><th width='25%'>Name</th><th width='75%'>Translation</th></tr>" );

						var translationNames_Sorted = Util.sortByKey( me.translationNames, "value" );


						$.each( translationNames_Sorted, function( i_translationName, item_translationName ) 
						{
							me.languageTableTag.append( "<tr class='translateDataRow' nameId='" + item_translationName.id + "'><td>" + item_translationName.value + "</td><td>" + "<textarea cols='30' rows='2'>" + me.getTranslationValue( item_translationName.id, jsonTranslation ) + "</textarea>" + "</td></tr>" );	
							
							// Do search/match of setting JSON at here and populate the existing data.
						});

					});
				}
			}


			this.getTranslationJSON = function( returnFunc )
			{
				DBSetting.getSettingValue( me.getLanuageDBSettingName()
				, function( json_Data ) 
				{
					returnFunc( json_Data );
				}
				, function() 
				{
					alert( 'Failed to retrieve translations!' );
				});
			}

			this.getTranslationValue = function( translationNameId, jsonTranslation )
			{
				var translationValue = "";

				if ( jsonTranslation !== undefined )
				{
					for (i = 0; i < jsonTranslation.length; i++ )
					{
						if ( jsonTranslation[i].id == translationNameId )
						{
							translationValue = jsonTranslation[i].value;
							break;
						}
					}
				}
	
				return translationValue;
			}


			this.setLanguageList = function( languageSelectTag )
			{
				// Add language list
				languageSelectTag.append( '<option Value="">Default</option>' );
				languageSelectTag.append( '<option Value="EN">English</option>' );
				languageSelectTag.append( '<option Value="SP">Spanish</option>' );

				// Set select event
				languageSelectTag.change( function()
				{
					// Save in Cookie
					$.cookie( me.languageRememberName, $( this ).val() , { expires: 700 } );

					// Switch the language
					me.setTranslation();
				});


				// Load the language remember
				var languageRem = $.cookie( me.languageRememberName );

				if ( languageRem !== undefined )
				{
					languageSelectTag.val( languageRem );

					// Switch the language
					me.setTranslation();
				}

			}

	
			this.setTranslation = function( sectionTag )
			{
				// Load Default fist. - and overwrite it afterwards (so that it gets cleaned)
				me.pouplateTranslation( sectionTag, me.translationNames );


				// Load Data from Setting - the proper language
				if ( me.languageSelectTag.val() != "" )
				{
					me.getTranslationJSON( function( jsonTranslation )
					{
						if ( jsonTranslation !== undefined )
						{
							me.pouplateTranslation( sectionTag, jsonTranslation );
						}
					});
				}
			}

			this.setTranslation_FromSource = function( sectionTag, sourceTag )
			{
				// If default language, do not need to translate.
				if ( me.languageSelectTag.val() != "" )
				{
					// Source has already been translated, so do not need to get translation from DB.
					sourceTag.find( 'span[nameId]' ).each( function( i )
					{
						var translationTag = $( this );

						sectionTag.find( 'span[nameId="' + translationTag.attr( 'nameId' ) + '"]' ).text( translationTag.text() );
					});
				}
			}


			this.pouplateTranslation = function( sectionTag, jsonTranslation )
			{
				// Load Default fist. - and overwrite it afterwards
				$.each( jsonTranslation, function( i_translation, item_translation ) {

					if ( item_translation.value != "")
					{
						if ( sectionTag === undefined )
						{
							$( "span[nameId='" + item_translation.id + "']" ).text( item_translation.value );
						}
						else
						{
							sectionTag.find( "span[nameId='" + item_translation.id + "']" ).text( item_translation.value );
						}
					}
				});
			}

			this.populateTranslationUnderSectionTag = function( sectionTag )
			{
				$.each( jsonTranslation, function( i_translation, item_translation ) {

					if ( item_translation.value != "")
					{
						$( "span[nameId='" + item_translation.id + "']" ).text( item_translation.value );
					}
				});
			}


			// ------------------------------------------


			this.FormPopupSetup = function()
			{

				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false,
				  dialogClass: "noTitleStuff",
				  width: 400,
				  height: 400,
				  modal: true,
				  buttons: {
					"Update": function() {

						var thisTag = $( this );

						var jsonData = [];
						
						// [ {id:"", value:""}, ]

						me.languageTableTag.find( "tr.translateDataRow" ).each( function()
						{
							// Create a json string and save it as setting value.

							var trCurrent = $( this );

							jsonData.push( { id: trCurrent.attr( 'nameId' ), value: trCurrent.find( 'textarea' ).val() } );

						});
						

						DBSetting.saveSettingValue( me.getLanuageDBSettingName(), jsonData
						, function() 
						{
							console.log( 'Successfully updated the translation value to systemSetting.' );

							me.setTranslation();

							thisTag.dialog( "close" );

						}
						, function()
						{
							console.log( 'Failed to update the translation value to systemSetting.' );
						}
						);


					},
					"Close": function() {

						//me.setTranslation();

						$( this ).dialog( "close" );
					}
				  }
				});		
			}


			// Initial Setup Call
			this.initialSetup = function()
			{				

				// Initialize language selection as default
				me.languageSelectTag.val( '' );


				// Create translation name list based on Span tag with 'nameId' attribute.
				me.setTranslationNameSets();


				me.FormPopupSetup();

				me.setLanguageList( me.languageSelectTag );

				me.languageEditTag.click( function() {

					if ( me.languageSelectTag.val() != "" )
					{
						me.setupForm();

						me.dialogFormTag.dialog( "open" );
					}
					else
					{
						alert( $( 'span.msg_DefaultLanguageEdit' ).text() );
					}

					return false;
				} );

			}


			// Initial Setup Call
			this.initialSetup();

		}

		// Class - LanguageSetting
		// -------------------------------------------


		// -------------------------------------------
		// Class - SettingForm
		//		- Used for popup Setting Form

		function SettingForm()
		{
			var me = this;

			this.dialogFormTag = $( "#settingDialogForm" );

			this.countryLevelTag = $( '#countryLevels' );

			this.width = 400;
			this.height = 250;

			this.dbSettingName = "App_TabularData_SettingData";

			this.queryURL_orgUnitLevels = _queryURL_api + 'organisationUnitLevels.json?paging=false&fields=id,name,level';

			this.settingData;


			this.FormPopupSetup = function()
			{
				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false
				  ,dialogClass: "noTitleStuff"
				  ,width: me.width
				  ,height: me.height				  
				  ,modal: true				
				  ,buttons: {
					"Save": function() {
						var dialogForm = $( this );

						// Check the value and 
						var checkFail = false;
						
						if ( me.countryLevelTag.val() == "" )
						{
							checkFail = true;
							alert( $( 'span.msg_SettingData_MandatoryCountryLevel' ).text() );
						}

						if ( !checkFail )
						{
							var json_SettingData = { 'countryLevel': me.countryLevelTag.val() };
							
							DBSetting.saveSettingValue( me.dbSettingName, json_SettingData
							, function()
							{
								me.settingData = json_SettingData;
								dialogForm.dialog( "close" );
							}
							, function()
							{
								alert( $( 'span.msg_SettingData_FailedToSave' ).text() );		
							});	
						}
					}
					,"Close": function()
					  {
						$( this ).dialog( "close" );
					  }

				  }				
				});		
			}


			this.openForm = function( status )
			{
				if ( status !== undefined && status == 'AtStart' )
				{
					me.dialogFormTag.find( '.ui-dialog-buttonpane' ).find( 'button:contains("Close")' ).button().hide();
				}

				me.populateSettingData();

				me.dialogFormTag.dialog( "open" );
			}

			this.populateSettingData = function()
			{
				if ( me.settingData !== undefined )
				{
					// set the tags value based on settingData
					if ( me.settingData.countryLevel !== undefined )
					{
						me.countryLevelTag.val( me.settingData.countryLevel );
					}
				}
			}

			this.getSettingData = function( execFunc )
			{
				if ( me.settingData !== undefined )
				{
					execFunc( me.settingData );
				}
				else
				{
					DBSetting.getSettingValue( me.dbSettingName
					, function( json_Data ) 
					{
						me.settingData = json_Data;

						execFunc( me.settingData );
					}
					, function( json_Data ) 
					{
						execFunc( me.settingData );
					});
				}
			}

			this.getCountryLevel = function()
			{
				var countryLevel;

				if ( me.settingData !== undefined )
				{
					countryLevel = me.settingData.countryLevel;
				}
				else
				{
					alert( $( 'span.msg_SettingData_CountryLevelNotDefined' ).text() );
				}

				return countryLevel;
			}


			// Check for existing country data and open if not setup yet
			this.checkRequiredData = function( json_Data )
			{
				if ( json_Data === undefined )
				{
					console.log( 'No setting data found.  Asking for setting data for the first time.' );

					me.openForm( 'AtStart' );
				}
				else if ( !( Util.checkDefined( json_Data ) && Util.checkValue( json_Data.countryLevel ) ) )
				{
					console.log( 'Setting data found, but country level is not set.  Asking for country level data.' );

					me.openForm( 'AtStart' );
				}				
			}


			this.loadSettingDataInitially_AndCheckRequired = function()
			{
				me.getSettingData( function( json_Data )
				{
					me.checkRequiredData( json_Data );
				});
			}

			this.setOrgUnitList = function( listTag )
			{
				listTag.empty();

				RESTUtil.getAsynchData( me.queryURL_orgUnitLevels
				, function( json_Data )
				{
					listTag.append( '<option value="">Select OrganisationUnit Level</option>' );

					if ( json_Data !== undefined )
					{
						var json_Levels = json_Data.organisationUnitLevels;

						var json_Levels_Sorted = Util.sortByKey( json_Levels, "level" );

						$.each( json_Levels_Sorted, function( i, item ) {

							listTag.append( $( '<option></option>' ).attr( "value", item.level ).text( 'Level ' + item.level + ' - ' + item.name ) );
						});
					}
				}
				, function() 
				{  
					alert( $( 'span.msg_SettingData_OrgUnitLevelNotFound' ).text() );
				});	

			}

			// Initial Setup Call
			this.initialSetup = function()
			{
				me.setOrgUnitList( me.countryLevelTag );
				
				me.FormPopupSetup();
			}

			// --------------------------
			// Run methods

			// Initial Run Call
			this.initialSetup();

		}

		// Class - SettingForm
		// -------------------------------------------


		// -------------------------------------------
		// OrgUnit Map Popup Class
		function OrgUnitMapPopup( TabularDEObj )
		{
			var me = this;

			this.TabularDEObj = TabularDEObj;

			this.dialogFormTag = $( "#orgUnitMapDialogForm" );

			this.tagId = '#orgUnitMapBig';
			this.tag = $( this.tagId );
			this.tagIdFront = this.tagId + ' ';

			this.width = 600;
			this.height = 600;

			this.centerLocation;
			this.latitude = 0;
			this.longitude = 0;

			this.gmap;
			this.currentEvent = null;

			this.zoomLvl_Init = 10;

			// overlay related
			this.overlays = new Array();
			this.marker_center;

			this.FormPopupSetup = function()
			{
				// -- Set up the form -------------------
				me.dialogFormTag.dialog({
				  autoOpen: false,
				  width: me.width,
				  height: me.height,
				  modal: true				
				});		
			}

			this.mapSetup = function( ) //centerLoc )
			{
				var menu = new Gmap3Menu( me.tag );

				var centerLoc = new google.maps.LatLng( me.latitude, me.longitude );

				// 1st call : init the map and create circles
				me.tag.gmap3({
					map:{
						options:{
							center: centerLoc
							,zoom: me.zoomLvl_Init
							,mapTypeId: google.maps.MapTypeId.ROADMAP
							,styles: [ { featureType: "poi", elementType: "labels", stylers: [ { visibility: "off" } ] } ]
							,streetViewControl: false
						}
						//,events:{ click: function(map, event){ }}
					}
				});
		
				me.gmap = me.tag.gmap3( 'get' );

				var marker = new google.maps.Marker({
					position: centerLoc
					,map: me.gmap
					,icon: 'img/blue.png'
				});
			}


			this.setUp_Map = function( latitude, longitude )
			{
				me.latitude = latitude;	
				me.longitude = longitude;
				
				GMapHelper.loadScript( '_TabularDEObj.orgUnitMapPopup.mapSetup' );
				//_TabularDEObj.orgUnitMapPopup.mapSetup

			}

			// Initial Setup Call
			this.initialSetup = function()
			{				
				me.FormPopupSetup();
			}

			// --------------------------
			// Run methods

			// Initial Run Call
			this.initialSetup();
		}

		// -------------------------------------------
		// OrgUnit Map Popup Class


		// -------------------------------------------
		// Google Map Helper Class (Static)

		function GMapHelper() {}

		GMapHelper.loadScript = function( callBack ) 
		{
			var script = document.createElement('script');

			script.type = 'text/javascript';

			script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyB0wy06coUW9kJYWXA8Gqh-hBkBB17odLw&sensor=true&libraries=geometry&callback=' + callBack;

			document.body.appendChild(script);
		}

		// Google Map Helper Class (Static)
		// -------------------------------------------

		// ============================================================================
		// ============================================================================


		// -------------------------------------------
		// -- Service Static Classes
		
		function FormUtil() {}

		FormUtil.setTagAsWait_SetRows = function( tagRows )
		{
			tagRows.each( function( i )
			{
				me.setTagAsWait( $( this ) );
			});
		}

		FormUtil.setTagAsWait = function( tag, classNameInput )
		{
			var className = ( classNameInput !== undefined ) ? classNameInput : 'waitRow' ;
			tag.addClass( className );
			
			Util.disableTag( tag, true );
		}
		
		FormUtil.setTagAsWait_Clear = function( tag, classNameInput )
		{
			var className = ( classNameInput !== undefined ) ? classNameInput : 'waitRow' ;
			tag.removeClass( className );
			
			Util.disableTag( tag, false );
		}


		// -------------------------------------------
		// -- PersonUtil Static Classes

		function PersonUtil() {}

		PersonUtil.primaryAttributeVal = "PrimaryAttributeVal";

		PersonUtil.getPersonByID = function( personId )
		{
			return $.parseJSON( RESTUtil.getSynchData( _queryURL_PersonQuery + "/" + personId + ".json" ) );			
		}

		PersonUtil.getPersonByID_Async = function( personId, successFunc )
		{
			return RESTUtil.getAsynchData( _queryURL_PersonQuery + "/" + personId + ".json"
			, successFunc
			, function() 
			{ 
				console.log( "FAILED -- PersonUtil getPersonByID_Async(), personId: " + personId ); 
			}
			);			
		}


		PersonUtil.addIDtypeToID = function( item_Person )
		{
			if ( Util.checkDefined( item_Person ) )
			{
				// Set attributeID as ID
				if( Util.checkDefined( item_Person.attributes ) )
				{
					$.each( item_Person.attributes, function( i_attribute, item_attribute ) 
					{
						item_attribute.id = item_attribute.attribute;
					});
				}
			}
		}


		PersonUtil.setPersonWithFirstAttributeData = function( personObjList, firstAttributeId )
		{
			$.each( personObjList, function( i_person, item_person )
			{
				var attritubeValue = "";

				// look for attribute value with id
				$.each( item_person.attributes, function( i_attribute, item_attribute )
				{
					if ( item_attribute.attribute == firstAttributeId )
					{
						attritubeValue = item_attribute.value;
						return false;
					}
				});

				item_person[ PersonUtil.primaryAttributeVal ] =  attritubeValue;
			});
		}


		// -------------------------------------------
		// -- EventUtil Static Classes 

		function EventUtil() {}

		// (Functions not yet populated much - move from PersonEvent class)

		EventUtil.preferredOptionGenerator;
		
		EventUtil.defaultOptionGenerator = function( item_Option )
		{
			return "<option value='" + item_Option + "'>" + item_Option + "</option>";
		}
		
		EventUtil.over2_16_OptionGenerator = function( item_Option )
		{
			return "<option value='" + item_Option.code + "'>" + item_Option.name + "</option>";
		}


		// Static Classes
		// =========================================================

		// =========================================================
		// Static Classes

		// Non-Genertic Util Helper Methods
		// -------

		// -------------------------------------------
		// -- Static Classes - Weekly/Monthly DatePicker Related

		function Weekly() {}

		Weekly.selectCurrentWeek = function() {
			window.setTimeout(function () {
				$('.ui-datepicker-calendar').filter( ':visible' ).find('.ui-datepicker-current-day a').addClass('ui-state-active');
			}, 1);
		}

		Weekly.setWeekPicker = function( inputTag, onSelectFunc )
		{
			inputTag.datepicker( {
			    changeMonth: true
				,changeYear: true
				,showOtherMonths: true
				,selectOtherMonths: true
				,showWeek: true
				,onSelect: function(dateText, inst) { 

					var date = $(this).datepicker('getDate');

					$(this).val( Weekly.getThisWeekStr( date ) );

					// Remove the event handler
					$( document ).off( 'mousemove', '.ui-datepicker-calendar:visible tr');
					$( document ).off( 'mouseleave', '.ui-datepicker-calendar:visible tr');

					if ( onSelectFunc !== undefined ) onSelectFunc();

				},
				beforeShowDay: function(date) {

					$( document ).on( 'mousemove', '.ui-datepicker-calendar:visible tr', function() { $(this).find('td a').addClass('ui-state-hover'); });

					$( document ).on( 'mouseleave', '.ui-datepicker-calendar:visible tr', function() { $(this).find('td a').removeClass('ui-state-hover'); });

					var cssClass = '';
					if( date >= _weekStartDate && date <= _weekEndDate )
						cssClass = 'ui-datepicker-current-day';
					return [true, cssClass];
				}
				,onChangeMonthYear: function( year, month, inst ) {
					Weekly.selectCurrentWeek();
				}
			});
		}

		Weekly.getThisWeekStr = function( date ) 
		{
			_weekStartDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
			_weekEndDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + 6);

			return $.format.date( _weekStartDate, _dateFormat_YYYYMMDD ) + ' - ' + $.format.date( _weekEndDate, _dateFormat_YYYYMMDD );
		}


		Weekly.getLastWeekStr = function( date ) 
		{
			_weekStartDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
 			_weekEndDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + 6);

			_weekStartDate.setDate( _weekStartDate.getDate() - 7 );
			_weekEndDate.setDate( _weekEndDate.getDate() - 7 );

			return $.format.date( _weekStartDate, _dateFormat_YYYYMMDD ) + ' - ' + $.format.date( _weekEndDate, _dateFormat_YYYYMMDD );
		}


		Weekly.getStartDate = function( weekStr ) 
		{
			var date;

			weekStr = Util.trim( weekStr );

			if ( weekStr.length == 23 )
			{
				var startDateStr = weekStr.substring(0, 10);

				date = Util.getDate_FromYYYYMMDD( startDateStr );
			}

			return date;
		}

		Weekly.getEndDate = function( weekStr ) 
		{
			var date;

			weekStr = Util.trim( weekStr );

			if ( weekStr.length == 23 )
			{
				var endDateStr = weekStr.substring(13, 23);

				date = Util.getDate_FromYYYYMMDD( endDateStr );
			}

			return date;
		}

		
		function Monthly() {}

		Monthly.populateMonthYear = function( monthTag, yearTag )
		{
			// Empty the list
			monthTag.empty();
			yearTag.empty();

			// Populate the month and year list
			monthTag.append( $( '<option></option>' ).attr( "value", 1 ).text( "January" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 2 ).text( "February" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 3 ).text( "March" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 4 ).text( "April" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 5 ).text( "May" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 6 ).text( "June" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 7 ).text( "July" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 8 ).text( "August" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 9 ).text( "September" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 10 ).text( "October" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 11 ).text( "November" ) );
			monthTag.append( $( '<option></option>' ).attr( "value", 12 ).text( "December" ) );
			
			for( i = 1990; i < 2020; i++ )
			{
				yearTag.append( $( '<option></option>' ).attr( "value", i ).text( i ) );
			}			
		}

		Monthly.setDate = function( monthTag, yearTag, date )
		{			
			monthTag.val( date.getMonth() ); // Previous month set.
			yearTag.val( date.getFullYear() );
		}

		Monthly.getStartDate = function( monthTag, yearTag )
		{
			return new Date( yearTag.val(), monthTag.val() - 1, 1 );
		}

		Monthly.getEndDate = function( monthTag, yearTag )
		{
			var date = new Date( yearTag.val(), monthTag.val(), 1 );

			// Set it to the last day of the last month.
			date.setDate( 0 );

			return date;
		}

		// -- Static Classes - Weekly/Monthly DatePicker Related
		// -------------------------------------------


		// -------------------------------------------
		// -- Static Classes - DB Setting Related

		function DBSetting() {}
		
		DBSetting._queryURL_SystemSettings = _queryURL_api + "systemSettings/";

		DBSetting.getSettingValue = function( settingName, successFunc, failFunc )
		{
			RESTUtil.getAsynchData( DBSetting._queryURL_SystemSettings + settingName
			, function( data )
			{
				successFunc( data );
			}
			, function( failMsg )
			{
				console.log( '[DBSetting.getSettingValue] Failed to get data from systemSettings/' + settingName + '.  Info: ' + JSON.stringify( failMsg ) );
				failFunc( failMsg );
			});
		}

		DBSetting.saveSettingValue = function( settingName, jsonData, successFunc, failFunc )
		{
			RESTUtil.submitData_Text( DBSetting._queryURL_SystemSettings + settingName, jsonData
			,successFunc, failFunc );
		}


		// -- Static Classes - DB Setting Related
		// -------------------------------------------

	</script>

</head>

<body>

<div id="dialog-loading">
	<table border="0" cellpadding="0" cellspacing="0" align="right" valign="top">
	<tr>
	<td><a id="forceClose" href="" style="color:Tomato;font-size:75%;">[X]</a></td>
	</tr>
	</table>
	<table border="0" cellpadding="0" cellspacing="0" width="180px" height="100%" align="center" valign="middle">
		<tr valign="middle">
			<td height="50px" valign="middle" align="right">
				<img src="img/loading_big_blue.gif" alt="Loading" />
			</td>
			<td height="50px" valign="middle" align="left" style="font-size: medium;">
				&nbsp;&nbsp;- Loading....
			</td>
		</tr>
	</table>
</div>

<div id="personDialogForm" class="ui-widget" style="margin:0;padding:0;">
	<b><span nameId='PersonInfo'>Person Info</span></b>
	<table id="person_Table" class="tbBorder" style="width:97%;">
	</table>
	<input id="person_Result" type="hidden" />
	<input id="person_formType" type="hidden" />
	<input id="person_id" type="hidden" />
</div>		

<div id="languageDialogForm" class="ui-widget" style="margin:0;padding:0;">
	<b><span nameId='LanguageTranslation'>Language Translation</span></b>
	<table id="language_Table" class="listTable" style="width:95%;">
	</table>
</div>

<div id="orgUnitMapDialogForm" class="ui-widget" style="margin:0;padding:0;">
	<div id="orgUnitMapBig" class="gmap3"></div>
</div>

<div id="settingDialogForm" class="ui-widget" style="margin:0;padding:0;">
	<b><span nameId='SettingFormTitle'>App Setting</span></b>
	<br>
	<br>
	<table id="setting_Table" class="listTable" style="width:95%;">
		<tr>
			<td>Country Level <span title='Compulsory' class='mandatory'>*</span></td><td><select id="countryLevels"></select></td>
		</tr>
	</table>
</div>


<div id="header">
	<img id="headerBanner" src="img/logo_banner.png" style="cursor:pointer" title="View home page">
	<span id="headerText" style="cursor:pointer" title="View home page"></span>
	<div id="headerRightSideControls">			
		<select id="language" style="background-color: White;"></select>&nbsp;<a id="languageEdit" href='' style="color: White;" >[E]</a>
			| <a href='' id='settingFormOpen' style="color: White;">Setting</a> | <a href="https://docs.google.com/document/d/1S6WD_oYdewVWFvsDnr1CL8yM2easN5mDc7j8QWI09Sw" target="_blank" style="color: White;">v 1.14</a>
			| <button type="button" id="closeButton"><span nameId='closeButton'>Close</span></button>
	</div>
</div>

<div style="display: block;margin-top: 35px;">

	<table border="0" cellpadding="0" cellspacing="0" width="100%">
		<tr>
			<td align="left" valign="top">

				<div style="margin-top: 3px;">

					<span nameId='MainTitle' class="pageTitle">Tabular Event/Tracker Capture</span><br>

					<table id="settingConsole" class="tbBorderNone">
					  <tr class="valignTop">

						<td id="orgUnitRow" style="display:none;">
							<table>
							<tr>
							  <td class="consoleTitle">	
								<span nameId='OrgUnit'>Org Unit:</span>
							  </td>
							  <td style="white-space: nowrap;">
								<input type="text" id="orgUnitName" size="30"/><span id="personFoundNo" style="font-size: 9px;color:#CCCCCC;"></span>
							  </td>
							 </tr>
							 </table>

							<div id='orgUnitLoading' style='display:none'>
								<img src='img/ui-anim_basic.gif'/> retrieving..
							</div>

							<div id='orgUnitLoading2' style='display:none'>
								<img src='img/ui-anim_basic.gif'/> retrieving..
							</div>

						</td>

						<td id="defaultProgramRow" style="display:none;">
							<table>
							<tr>
							  <td class="consoleTitle">	
								<span nameId='DefaultProgram'>Program:</span>
							  </td>
							  <td>
								<select id="defaultProgram"></select> 
							  </td>
							 </tr>
							 </table>

							<div id='programLoading' style='display:none'>
								<img src='img/ui-anim_basic.gif'/> loading..
							</div>

						</td>

						<td id="defaultDateRow" style="display:none;">
							<table>
							<tr>
							  <td class="consoleTitle">	
								<span nameId='Period'>Period:</span>
							  </td>
							  <td style="white-space: nowrap;">
								<input type="radio" name="period" value="month"/><span nameId='PeriodMonth'>Month</span>
								<input type="radio" name="period" value="week"/><span nameId='PeriodWeek'>Week</span>
								<input type="radio" name="period" value="custom"/><span nameId='PeriodOther'>Custom</span>
								
								<span id="defaultMonth" style="display:none;"><select id="defaultMonth_Month"></select> <select id="defaultMonth_Year"></select></span> 

								<input type="text" id="defaultWeek" class="defaultDatePicker" size="28" style="display:none;"></input>

								<span id="defaultDatePeriod" style="display:none;"><input type="text" id="defaultDateFrom" class="defaultDatePicker" size="14"></input> - <input type="text" id="defaultDateTo" class="defaultDatePicker" size="14"></input></span>
							  </td>
							</tr>
							</table>
						</td>
					  </tr>
					  <tr id="personEventSearchOptions" style="display:none;">
						<td colspan="3" class="valignTop">

							<span nameId='ProgramStatus'>Program Status:</span><select id="programStatusList">
								<option value="ACTIVE">Active</option>
								<option value="COMPLETED">Completed</option>
								<option value="CANCELLED">Cancelled</option>
							</select>&nbsp;&nbsp;

							<input id="searchAllProgram" type="checkbox" style="vertical-align:bottom;" /><span nameId='SearchAllProgram' style="color:#222222; font-style:italic;">Search All Program Under Person</span>&nbsp;&nbsp;&nbsp;
							<input id="listAllPersonHistoricalEvents" type="checkbox" style="vertical-align:bottom;" /><span nameId='ListAllHistoricalEvents' style="color:#222222; font-style:italic;">List All Historical Events Under Person</span>
						</td>
					  </tr>
					  <tr id="searchResultMsgRow" style="display:none;">
						<td colspan="3">
							&nbsp;&nbsp;<span id="searchResultMessage" style="color:#444444;font-style:italic;"> </span>
							&nbsp;&nbsp;<span id="defaultProgramNote"></span>
						</td>
					  </tr>
					  </table>
				</div>

			</td>
			<td align="right" valign="top">
				<div id="orgUnitMapSmall" style="display:none;margin-top:2px;margin-right:4px;"><a href="" id="orgUnitMapAnchor"><img id="orgUnitMapImage" src="" alt="" /></a></div>
			</td>
		</tr>
	</table>


	<div style="line-height:5px;"></div>
	<br>

	<div id="mainSection_Person" class="tbStyle_Person">

		<table id="mainTable_Person" border="1" class="tbStyle_Person" style="font-size:small;">
			<colgroup>
				<col />
				<col width="100px" />
			</colgroup>
		</table>	
		<div style="margin-top:4px;">
		<button type="button" id="person_addNewRow" class="input_button" ><span nameId='AddNewRow'>Add new row</span></button>
		</div>
	</div>


	<div id="mainSection_Event" class="tbStyle_Person">
		<table id="mainTable_Event" border="1" class="tbStyle_PersonDetail" style="margin-left: 0px;font-size:small;">
			<tr class='trEventHead'>
				<th class='orig' align='center'><span nameId='EventTableHeader_Date'>Date</span></th>
				<th class='orig'></th>
				<th class='orig' align='center'><span nameId='EventTableHeader_Status'>Status</span></th>
				<th class='orig' type='delete'>&nbsp;</th>
			</tr>
		</table>
		<button type='button' class='personEvent_addNewRow input_button' style="margin-top:4px;"><span nameId='AddNewEventRow'>Add Event</span></button>
	</div>


	<br>

	<div id="translationTagDiv" style="display:none;">
		<span nameId='AddPerson'>Add Person</span>
		<span nameId='UpdatePerson'>Update Person</span>

		<span nameId='EventTableHeader_Date_OrgUnit'>Date / OrgUnit</span>
		<span nameId='EventTableHeader_Program_Stage'>Program / Stage</span>
		<span nameId='EventTableHeader_Status'>Status</span>
		<span nameId='AddNewEventRow'>Add Event</span>

		<span nameId='CreateEvent'>Create</span>
		<span nameId='CompleteEvent'>Complete</span>

		<span class="msg_MandatoryFill" nameId='Msg_MandatoryFill'>[Message] Mandatory field has to be filled.</span>
		<span class="msg_NoProgramAttributes" nameId='Msg_NoProgramAttributes'>[Message] The selected program does not have any person attribtues.</span>
		<span class="msg_SelectDefaultProgram" nameId='Msg_SelectDefaultProgram'>[Message] Please select the default program in order to proceed this.</span>
		<span class="msg_ProgramAttributeAtLeast" nameId='Msg_ProgramAttributeAtLeast'>[Message] The program needs to have at least one display attribute for this!</span>
		<span class="msg_SamePersonInList" nameId='Msg_SamePersonInList'>[Message] The same person exists in the list already.</span>
		<span class="msg_CanNotEnrol_PreviousEnroll" nameId='Msg_CanNotEnrol_PreviousEnroll'>[Message] Can not enroll to the program.  It has previous non-active enrollment to the program and the program is set to only enroll once.</span>
		<span class="msg_CheckEventDateStage" nameId='Msg_CheckEventDateStage'>[Message] Please check event date value and event stage selection, and try again.</span>
		<span class="msg_FailedToEnroll" nameId='Msg_FailedToEnroll'>[Message] Failed to enroll - </span>
		<span class="msg_FailedToCreateEvent" nameId='Msg_FailedToCreateEvent'>[Message] Failed to create the event: </span>
		<span class="msg_EventDeleted" nameId='Msg_EventDeleted'>[Message] Successfully deleted the event!</span>
		<span class="msg_EventDeleteFailed" nameId='Msg_EventDeleteFailed'>[Message] Failed to delete the event!</span>
		<span class="msg_EventRetrievalFailed" nameId='Msg_EventRetrievalFailed'>[Message] Failed to retrieve the events!</span>
		<span class="msg_EventUpdateFailed" nameId='Msg_EventUpdateFailed'>[Message] Failed to update the event</span>
		<span class="msg_CompulsoryFill" nameId='Msg_CompulsoryFill'>[Message] Please fill the compulsory fields in order to proceed.</span>
		<span class="msg_PersonNotFoundDHIS" nameId='Msg_PersonNotFoundDHIS'>[Message] Tracked Entity 'Person' was not found in this DHIS system.  Please add 'Person' Tracked Entity first.</span>
		<span class="msg_SelectDefaultProgram" nameId='Msg_SelectDefaultProgram'>[Message] Please select the Default Program.</span>
		<span class="msg_PersonNotFound" nameId='Msg_PersonNotFound'>[Message] Person Not Found</span>
		<span class="msg_PersonCreated" nameId='Msg_PersonCreated'>[Message] Person created successfully!</span>
		<span class="msg_ProgramEnrolled" nameId='Msg_ProgramEnrolled'>[Message] Enrolled to the program</span>
		<span class="msg_ProgramEnrollFailed" nameId='Msg_ProgramEnrollFailed'>[Message] Failed to enroll - </span>
		<span class="msg_PersonInfoUpdated" nameId='Msg_PersonInfoUpdated'>[Message] Person info updated successfully!</span>
		<span class="msg_PersonCreateUpdateFailed" nameId='Msg_PersonCreateUpdateFailed'>[Message] Failed to create/update the person.  Detail: </span>
		<span class="msg_DefaultLanguageEdit" nameId='Msg_DefaultLanguageEdit'>[Message] Default langauge can not be edited.</span>
		<span class="msg_SettingData_MandatoryCountryLevel" nameId='Msg_SettingData_MandatoryCountryLevel'>[Message] Country Level is a mandatory field.  Please set the Country Level to continue.</span>
		<span class="msg_SettingData_FailedToSave" nameId='Msg_SettingData_FailedToSave'>[Message] Failed to save the setting data.</span>
		<span class="msg_SettingData_CountryLevelNotDefined" nameId='Msg_SettingData_CountryLevelNotDefined'>[Message] Country Level is not defined!  Aborted the task.</span>
		<span class="msg_SettingData_OrgUnitLevelNotFound" nameId='Msg_SettingData_OrgUnitLevelNotFound'>[Message] Organisation Unit Level not found.  Please check Organisation Unit level set or manifest.webapp dhis.href value.</span>

		<span class="msg_ConfirmDelete" nameId='Msg_ConfirmDelete'>[Confirm] Are you sure that you want to delete?</span>
		<span class="msg_ConfirmEventComplete" nameId='Msg_ConfirmEventComplete'>[Confirm] Are you sure that you want to set this event as completed?</span>
	</div>
</div>

</body>

</html>
